{% extends 'base/base.html' %}
{% load static %}
{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded-2xl shadow-md border border-t-[15px] border-t-blue-500">
  <h1 class="text-2xl font-semibold text-blue-500 mb-4">{{ title_section }}</h1>

  <form method="post" class="space-y-4">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-error mb-4">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {% if error %}
      <div class="alert alert-error mb-4">
        {{ error }}
      </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
      <!-- Columna izquierda: campos NO checkbox -->
      <div>
        <div class="space-y-4">
          {% for field in form %}
              {% if field.field.widget.input_type != 'checkbox' and field.name != 'notes' %}
              <div class="form-control field-row" data-field-name="{{ field.name }}">
                <label class="label">
                  <span class="label-text text-sm font-medium">{{ field.label }}</span>
                </label>
                {{ field }}
                {% if field.errors %}
                  <label class="label">
                    <span class="label-text-alt text-error">{{ field.errors.0 }}</span>
                  </label>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Columna derecha: SOLO checkboxes -->
      <div>
        <div class="space-y-2">
          {% for field in form %}
            {% if field.field.widget.input_type == 'checkbox' %}
              <div class="form-control field-row" data-field-name="{{ field.name }}">
                <label class="label cursor-pointer items-center gap-2">
                  {{ field }}
                  <span class="label-text text-sm font-medium">{{ field.label }}</span>
                </label>
                {% if field.errors %}
                  <label class="label">
                    <span class="label-text-alt text-error">{{ field.errors.0 }}</span>
                  </label>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
            {# Campo de notas debajo de los checks #}
            {% if form.notes %}
            <div class="form-control field-row mt-4" data-field-name="notes">
              <label class="label">
                <span class="label-text text-sm font-medium">{{ form.notes.label|default:'Notas' }}</span>
              </label>
              {{ form.notes }}
              {% if form.notes.errors %}
                <label class="label">
                  <span class="label-text-alt text-error">{{ form.notes.errors.0 }}</span>
                </label>
              {% endif %}
            </div>
            {% endif %}
        </div>
      </div>
    </div>

    <div class="flex flex-wrap justify-center gap-2 mt-6 border-t pt-4">
      <button type="submit" class="btn btn-primary">
        <i class="las la-save text-xl"></i>
        {% if is_update %}Actualizar{% else %}Guardar{% endif %} Equipo
      </button>
      <a href="{% url 'resource_list' %}" class="btn btn-secondary">
        <i class="las la-arrow-left text-xl"></i>
        Cancelar
      </a>
      {% if is_update and equipment %}
        <a href="{% url 'resource_detail' equipment.id %}" class="btn btn-secondary">
          <i class="las la-eye text-xl"></i>
          Ver Detalle
        </a>
      {% endif %}
    </div>
  </form>
</div>
{% block script %}
{{ block.super }}
<script>
  (function() {
    // Mapa tipo -> campos permitido, provisto por la vista
    const typeFieldsMap = JSON.parse('{{ type_fields_map_json|escapejs }}');
    const initialType = '{{ initial_type|default:"SERVIC" }}';

    // Recolectar todos los contenedores de campos por nombre
    const fieldRows = Array.from(document.querySelectorAll('.field-row'));
    const fieldRowByName = {};
    fieldRows.forEach(row => {
      const name = row.getAttribute('data-field-name');
      if (name) fieldRowByName[name] = row;
    });

    // Select de tipo
    const typeSelect = document.getElementById('id_type_equipment');

    function showOnly(fields) {
      const allowed = new Set(fields);
      fieldRows.forEach(row => {
        const name = row.getAttribute('data-field-name');
        // Siempre mostrar 'name' y 'code' como mÃ­nimos
    const mustShow = allowed.has(name) || name === 'name' || name === 'code' || name === 'type_equipment' || name === 'notes';
        row.style.display = mustShow ? '' : 'none';
      });
    }

    function applyType(typeVal) {
      const fields = typeFieldsMap[typeVal] || typeFieldsMap['SERVIC'] || [];
      showOnly(fields);
    }

    if (typeSelect) {
      typeSelect.addEventListener('change', (e) => applyType(e.target.value));
      // Aplicar inicial
      const current = typeSelect.value || initialType;
      applyType(current);
    } else {
      // Fallback
      applyType(initialType);
    }
  })();
  </script>
{% endblock %}
{% endblock %}