{% extends 'base/base.html' %}
{% load static %}
{% block style %}{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto p-6 bg-white rounded-2xl shadow border border-t-8 border-t-blue-500">
  <div class="flex flex-wrap gap-2 justify-between items-center mb-4 pb-2 border-b">
    <h1 class="text-xl font-semibold text-blue-600">{{ title_section|default:"Formulario de Vehículo" }}</h1>
    <div class="flex flex-wrap gap-2">
    
      <a href="{% url 'vehicle_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </div>

  {% if form.errors %}
  <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-r-xl mb-6">
    <p class="text-red-700 font-medium text-sm">Hay errores en el formulario. Revisa los campos marcados.</p>
  </div>
  {% endif %}

  <form method="post" class="space-y-6">
    {% csrf_token %}
    <div class="grid md:grid-cols-3 gap-8">
      <!-- Columna 1: Datos básicos -->
      <div class="space-y-4">
        <h3 class="text-sm font-semibold text-gray-600 tracking-wide">Datos Básicos</h3>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Placa</span></label>
          <input name="{{ form.no_plate.html_name }}" value="{{ form.no_plate.value|default:'' }}" type="text" class="input input-bordered h-9" placeholder="Placa" {% if form.no_plate.field.required %}required{% endif %}>
          {% if form.no_plate.errors %}<span class="text-xs text-red-500">{{ form.no_plate.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Tipo</span></label>
          <select name="{{ form.type_vehicle.html_name }}" class="select select-bordered h-9" {% if form.type_vehicle.field.required %}required{% endif %}>
            <option value="">Seleccione</option>
            {% for value, label in form.type_vehicle.field.choices %}
              <option value="{{ value }}" {% if form.type_vehicle.value == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          {% if form.type_vehicle.errors %}<span class="text-xs text-red-500">{{ form.type_vehicle.errors.0 }}</span>{% endif %}
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Marca</span></label>
            <input name="{{ form.brand.html_name }}" value="{{ form.brand.value|default:'' }}" class="input input-bordered h-9" placeholder="Marca">
            {% if form.brand.errors %}<span class="text-xs text-red-500">{{ form.brand.errors.0 }}</span>{% endif %}
          </div>
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Modelo</span></label>
            <input name="{{ form.model.html_name }}" value="{{ form.model.value|default:'' }}" class="input input-bordered h-9" placeholder="Modelo">
            {% if form.model.errors %}<span class="text-xs text-red-500">{{ form.model.errors.0 }}</span>{% endif %}
          </div>
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Año</span></label>
          <input name="{{ form.year.html_name }}" value="{{ form.year.value|default:'' }}" type="number" class="input input-bordered h-9" placeholder="Año">
          {% if form.year.errors %}<span class="text-xs text-red-500">{{ form.year.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Propietario</span></label>
          <input name="{{ form.owner_transport.html_name }}" value="{{ form.owner_transport.value|default:'PEISOL' }}" class="input input-bordered h-9" placeholder="Propietario">
          {% if form.owner_transport.errors %}<span class="text-xs text-red-500">{{ form.owner_transport.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Estado</span></label>
          <select name="{{ form.status_vehicle.html_name }}" class="select select-bordered h-9">
            {% for value, label in form.status_vehicle.field.choices %}
              <option value="{{ value }}" {% if form.status_vehicle.value == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          {% if form.status_vehicle.errors %}<span class="text-xs text-red-500">{{ form.status_vehicle.errors.0 }}</span>{% endif %}
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Color</span></label>
            <input name="{{ form.color.html_name }}" value="{{ form.color.value|default:'' }}" class="input input-bordered h-9" placeholder="Color">
            {% if form.color.errors %}<span class="text-xs text-red-500">{{ form.color.errors.0 }}</span>{% endif %}
          </div>
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Chasis</span></label>
            <input name="{{ form.chassis_number.html_name }}" value="{{ form.chassis_number.value|default:'' }}" class="input input-bordered h-9" placeholder="Chasis">
            {% if form.chassis_number.errors %}<span class="text-xs text-red-500">{{ form.chassis_number.errors.0 }}</span>{% endif %}
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Motor</span></label>
            <input name="{{ form.engine_number.html_name }}" value="{{ form.engine_number.value|default:'' }}" class="input input-bordered h-9" placeholder="Motor">
            {% if form.engine_number.errors %}<span class="text-xs text-red-500">{{ form.engine_number.errors.0 }}</span>{% endif %}
          </div>
          <div class="form-control">
            <label class="label pb-1"><span class="label-text text-xs font-semibold">Serie</span></label>
            <input name="{{ form.serial_number.html_name }}" value="{{ form.serial_number.value|default:'' }}" class="input input-bordered h-9" placeholder="Serie">
            {% if form.serial_number.errors %}<span class="text-xs text-red-500">{{ form.serial_number.errors.0 }}</span>{% endif %}
          </div>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer gap-2 pb-1"><input type="checkbox" name="{{ form.is_active.html_name }}" class="checkbox checkbox-primary" {% if form.is_active.value %}checked{% endif %}><span class="label-text text-xs font-semibold">Activo</span></label>
          {% if form.is_active.errors %}<span class="text-xs text-red-500">{{ form.is_active.errors.0 }}</span>{% endif %}
        </div>
      </div>

      <!-- Columna 2: Seguros -->
      <div class="space-y-4">
        <h3 class="text-sm font-semibold text-gray-600 tracking-wide">Seguros</h3>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Compañía</span></label>
          <input name="{{ form.insurance_company.html_name }}" value="{{ form.insurance_company.value|default:'' }}" class="input input-bordered h-9" placeholder="Compañía">
          {% if form.insurance_company.errors %}<span class="text-xs text-red-500">{{ form.insurance_company.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Póliza</span></label>
          <input name="{{ form.nro_poliza.html_name }}" value="{{ form.nro_poliza.value|default:'' }}" class="input input-bordered h-9" placeholder="Póliza">
          {% if form.nro_poliza.errors %}<span class="text-xs text-red-500">{{ form.nro_poliza.errors.0 }}</span>{% endif %}
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Emisión</span></label>
            <input id="id_insurance_issue_date" type="date" name="{{ form.insurance_issue_date.html_name }}" value="{{ form.insurance_issue_date.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
            {% if form.insurance_issue_date.errors %}<span class="text-xs text-red-500">{{ form.insurance_issue_date.errors.0 }}</span>{% endif %}
          </div>
          <div class="form-control">
            <label class="label pb-1 flex justify-between items-center">
              <span class="label-text text-xs font-semibold">Vencimiento</span>
              <span id="insuranceExpiryBadge" class="badge badge-ghost badge-sm hidden"></span>
            </label>
            <input id="id_insurance_expiration_date" type="date" name="{{ form.insurance_expiration_date.html_name }}" value="{{ form.insurance_expiration_date.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
            {% if form.insurance_expiration_date.errors %}<span class="text-xs text-red-500">{{ form.insurance_expiration_date.errors.0 }}</span>{% endif %}
          </div>
        </div>
        <div class="form-control">
          <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Satelital</span><span id="satelliteExpiryBadge" class="badge badge-ghost badge-sm hidden"></span></label>
          <input id="id_due_date_satellite" type="date" name="{{ form.due_date_satellite.html_name }}" value="{{ form.due_date_satellite.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
          {% if form.due_date_satellite.errors %}<span class="text-xs text-red-500">{{ form.due_date_satellite.errors.0 }}</span>{% endif %}
        </div>
        <div class="divider my-2"></div>
        <h3 class="text-sm font-semibold text-gray-600 tracking-wide">Documentos</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-control">
            <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Fecha Matrícula</span></label>
            <input id="id_date_matricula" type="date" name="{{ form.date_matricula.html_name }}" value="{{ form.date_matricula.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
            {% if form.date_matricula.errors %}<span class="text-xs text-red-500">{{ form.date_matricula.errors.0 }}</span>{% endif %}
          </div>
            <div class="form-control">
            <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Venc. Matrícula</span><span id="matriculaExpiryBadge" class="badge badge-ghost badge-sm hidden"></span></label>
            <input id="id_due_date_matricula" type="date" name="{{ form.due_date_matricula.html_name }}" value="{{ form.due_date_matricula.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
            {% if form.due_date_matricula.errors %}<span class="text-xs text-red-500">{{ form.due_date_matricula.errors.0 }}</span>{% endif %}
          </div>
        </div>
        <div class="form-control">
          <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Venc. Cert. Operación</span><span id="certOperExpiryBadge" class="badge badge-ghost badge-sm hidden"></span></label>
          <input id="id_due_date_cert_oper" type="date" name="{{ form.due_date_cert_oper.html_name }}" value="{{ form.due_date_cert_oper.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
          {% if form.due_date_cert_oper.errors %}<span class="text-xs text-red-500">{{ form.due_date_cert_oper.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1"><span class="label-text text-xs font-semibold">Estado Certificado</span></label>
          <select name="{{ form.status_cert_oper.html_name }}" class="select select-bordered h-9">
            <option value="">Seleccione</option>
            {% for value, label in form.status_cert_oper.field.choices %}
              <option value="{{ value }}" {% if form.status_cert_oper.value == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          {% if form.status_cert_oper.errors %}<span class="text-xs text-red-500">{{ form.status_cert_oper.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Fecha MTOP</span><span id="mtopExpiryBadge" class="badge badge-ghost badge-sm hidden"></span></label>
          <input id="id_date_mtop" type="date" name="{{ form.date_mtop.html_name }}" value="{{ form.date_mtop.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
          {% if form.date_mtop.errors %}<span class="text-xs text-red-500">{{ form.date_mtop.errors.0 }}</span>{% endif %}
        </div>
        <div class="form-control">
          <label class="label pb-1 flex justify-between items-center"><span class="label-text text-xs font-semibold">Fecha Rev. Técnica</span><span id="technicalReviewExpiryBadge" class="badge badge-ghost badge-sm hidden"></span></label>
          <input id="id_date_technical_review" type="date" name="{{ form.date_technical_review.html_name }}" value="{{ form.date_technical_review.value|date:'Y-m-d'|default:'' }}" class="input input-bordered h-9">
          {% if form.date_technical_review.errors %}<span class="text-xs text-red-500">{{ form.date_technical_review.errors.0 }}</span>{% endif %}
        </div>
      </div>

      <!-- Columna 3: Notas y espacio para app JS -->
      <div class="space-y-4">
        <h3 class="text-sm font-semibold text-gray-600 tracking-wide">Notas</h3>
        <div class="form-control">
          <textarea name="{{ form.notes.html_name }}" class="textarea textarea-bordered min-h-40" placeholder="Notas adicionales">{{ form.notes.value|default:'' }}</textarea>
          {% if form.notes.errors %}<span class="text-xs text-red-500">{{ form.notes.errors.0 }}</span>{% endif %}
        </div>
      </div>
    </div>

    <div class="flex justify-center gap-3 pt-4 border-t">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'vehicle_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block script %}
<script id="vehicle-data" type="application/json">
{
  "vehicle": {% if vehicle %}{
    "id": {{ vehicle.id }},
    "brand": "{{ vehicle.brand|default:''|escapejs }}",
    "model": "{{ vehicle.model|default:''|escapejs }}",
    "type_vehicle": "{{ vehicle.type_vehicle|default:''|escapejs }}",
    "year": {% if vehicle.year %}{{ vehicle.year }}{% else %}null{% endif %},
    "no_plate": "{{ vehicle.no_plate|default:''|escapejs }}",
    "owner_transport": "{{ vehicle.owner_transport|default:'PEISOL'|escapejs }}",
    "status_vehicle": "{{ vehicle.status_vehicle|default:'DISPONIBLE'|escapejs }}",
    "color": "{{ vehicle.color|default:''|escapejs }}",
    "chassis_number": "{{ vehicle.chassis_number|default:''|escapejs }}",
    "engine_number": "{{ vehicle.engine_number|default:''|escapejs }}",
    "serial_number": "{{ vehicle.serial_number|default:''|escapejs }}",
    "is_active": {% if vehicle.is_active %}true{% else %}false{% endif %},
    "notes": "{{ vehicle.notes|default:''|escapejs }}",
    "insurance_company": "{{ vehicle.insurance_company|default:''|escapejs }}",
    "nro_poliza": "{{ vehicle.nro_poliza|default:''|escapejs }}",
    "insurance_issue_date": "{{ vehicle.insurance_issue_date|date:'Y-m-d'|default:''|escapejs }}",
    "insurance_expiration_date": "{{ vehicle.insurance_expiration_date|date:'Y-m-d'|default:''|escapejs }}",
    "due_date_satellite": "{{ vehicle.due_date_satellite|date:'Y-m-d'|default:''|escapejs }}",
    "date_matricula": "{{ vehicle.date_matricula|date:'Y-m-d'|default:''|escapejs }}",
    "due_date_matricula": "{{ vehicle.due_date_matricula|date:'Y-m-d'|default:''|escapejs }}",
    "due_date_cert_oper": "{{ vehicle.due_date_cert_oper|date:'Y-m-d'|default:''|escapejs }}",
    "status_cert_oper": "{{ vehicle.status_cert_oper|default:''|escapejs }}",
    "date_mtop": "{{ vehicle.date_mtop|date:'Y-m-d'|default:''|escapejs }}",
    "date_technical_review": "{{ vehicle.date_technical_review|date:'Y-m-d'|default:''|escapejs }}"
  }{% else %}null{% endif %},
  "certifications": [
    {% if vehicle %}{% for c in vehicle.certificationvehicle_set.all %}{
      "name": "{{ c.name|escapejs }}",
      "date_start": "{{ c.date_start|date:'Y-m-d' }}",
      "date_end": "{{ c.date_end|date:'Y-m-d'|default:'' }}",
      "description": "{{ c.description|default:''|escapejs }}"
    }{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ],
  "passes": [
    {% if vehicle %}{% for p in vehicle.passvehicle_set.all %}{
      "bloque": "{{ p.bloque|escapejs }}",
      "fecha_caducidad": "{{ p.fecha_caducidad|date:'Y-m-d' }}"
    }{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ]
}
</script>
<script>
(function(){
  try {
    const raw = document.getElementById('vehicle-data').textContent.trim();
    window.vehicleData = JSON.parse(raw);
    console.log('vehicleData', window.vehicleData);
  } catch(e) { console.error('Error parseando vehicle-data', e); }
})();
</script>
<script src="{% static 'js/app/app-vehicle_form.js' %}"></script>
<style>
@keyframes pulse { 0% { opacity:1 } 50% { opacity:.5 } 100% { opacity:1 } }
</style>
{% endblock %}
