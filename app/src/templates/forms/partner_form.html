{% extends 'base/base.html' %}

{% block content %}
<div class="container mx-auto mt-3 mb-3 p-4 shadow-lg rounded-lg bg-base-100">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
        <h1 class="text-2xl font-semibold text-primary mb-2 md:mb-0">{{ title_section }}</h1>
        <div class="flex flex-wrap gap-2">
            {% if request.resolver_match.url_name != 'partner_create' %}    
            <a href="{% url 'partner_detail' request.resolver_match.kwargs.pk %}?action=delete" class="btn btn-sm btn-outline btn-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                </svg>
                Eliminar
            </a>
            <a href="{% url 'partner_detail' partner.id %}" class="btn btn-sm btn-outline btn-info border-black">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l14 0" /><path d="M5 12l6 6" /><path d="M5 12l6 -6" />
                </svg>
                Volver a Ficha
            </a>
            {% endif %}
            <a href="{% url 'partner_list' %}" class="btn btn-sm btn-outline border-black">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M5.7 5.7l12.6 12.6" />
                  </svg>
                Cancelar
            </a>
        </div>
    </div>
</div>

<div class="container mx-auto mt-2 p-4">
    <div class="card bg-base-100 shadow-xl border border-gray-500">
        <div class="card-body">
            <h2 class="card-title text-secondary mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" />
                </svg>
                Información del Socio de Negocio
            </h2>

            {% if form.errors %}
            <div class="alert alert-error shadow-lg mb-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Por favor, corrige los errores en el formulario.</span>
                </div>
            </div>
            {% endif %}

            <form action="" method="post">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="form-control">
                        <label class="label" for="{{ form.business_tax_id.id_for_label }}"><span class="label-text">RUC:</span></label>
                        {{ form.business_tax_id }} <!-- Expected class: input -->
                        {% if form.business_tax_id.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.business_tax_id.errors }}</span></label>{% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ form.name.id_for_label }}"><span class="label-text">Nombre del Socio:</span></label>
                        {{ form.name }} <!-- Expected class: input -->
                        {% if form.name.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.name.errors }}</span></label>{% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ form.email.id_for_label }}"><span class="label-text">Correo Electrónico:</span></label>
                        {{ form.email }} <!-- Expected class: input -->
                        {% if form.email.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.email.errors }}</span></label>{% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ form.phone.id_for_label }}"><span class="label-text">Teléfono:</span></label>
                        {{ form.phone }} <!-- Expected class: input -->
                        {% if form.phone.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.phone.errors }}</span></label>{% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ form.address.id_for_label }}"><span class="label-text">Dirección:</span></label>
                        {{ form.address }} <!-- Expected class: input -->
                        {% if form.address.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.address.errors }}</span></label>{% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label" for="{{ form.name_contact.id_for_label }}"><span class="label-text">Nombre de Contacto:</span></label>
                        {{ form.name_contact }} <!-- Expected class: input -->
                        {% if form.name_contact.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.name_contact.errors }}</span></label>{% endif %}
                    </div>
                     <div class="form-control md:col-span-3">
                        <label class="label" for="{{ form.notes.id_for_label }}"><span class="label-text">Notas:</span></label>
                        {{ form.notes }} <!-- Expected class: textarea -->
                        {% if form.notes.errors %}<label class="label"><span class="label-text-alt text-error">{{ form.notes.errors }}</span></label>{% endif %}
                    </div>
                </div>
                
                {% if request.resolver_match.url_name != 'partner_create' %}
                <div class="divider">Autorizaciones</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">     
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Técnicos</h3>
                        <div class="overflow-x-auto max-h-60 border rounded-lg">
                            <table class="table table-zebra table-xs w-full">
                                <thead class="sticky top-0 bg-base-200 z-10">
                                    <tr>
                                        <th class="p-2 text-center">Nombre</th>
                                        <th class="p-2 text-center">Cargo</th>
                                        <th class="p-2 text-center">Autorizado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in technicals" :key="item.id" @click="saveItem(item, 'technical')" class="cursor-pointer hover:bg-base-300">
                                        <td class="p-2">[[ item.last_name ]] [[ item.first_name ]]</td>
                                        <td class="p-2">[[ item.role ]]</td>
                                        <td class="p-2 text-center">
                                            <input type="checkbox" :checked="item.is_registered" class="checkbox checkbox-primary checkbox-xs pointer-events-none" />
                                        </td>
                                    </tr>
                                    <tr v-if="technicals.length === 0">
                                        <td colspan="3" class="p-2 text-center text-base-content/70">No hay técnicos disponibles.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Vehículos</h3>
                        <div class="overflow-x-auto max-h-60 border rounded-lg">
                            <table class="table table-zebra table-xs w-full">
                                <thead class="sticky top-0 bg-base-200 z-10">
                                    <tr>
                                        <th class="p-2 text-center">Placa</th>
                                        <th class="p-2 text-center">Tipo</th>
                                        <th class="p-2 text-center">Autorizado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in vehicles" :key="item.id" @click="saveItem(item, 'vehicle')" class="cursor-pointer hover:bg-base-300">
                                        <td class="p-2">[[ item.no_plate ]]</td>
                                        <td class="p-2">[[ item.type_vehicle ]]</td>
                                        <td class="p-2 text-center">
                                            <input type="checkbox" :checked="item.is_registered" class="checkbox checkbox-primary checkbox-xs pointer-events-none" />
                                        </td>
                                    </tr>
                                     <tr v-if="vehicles.length === 0">
                                        <td colspan="3" class="p-2 text-center text-base-content/70">No hay vehículos disponibles.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card-actions justify-end mt-6">
                    <button type="submit" class="btn btn-primary border border-black">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" /><path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M14 4l0 4l-6 0l0 -4" />
                        </svg>
                        Guardar Socio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% if request.resolver_match.url_name != 'partner_create' %}
    {% block script_app %} <!-- Cambiado de script a script_app para evitar conflicto con el bloque de base.html -->
    <script>
        // Asegúrate que estas variables globales se definan antes de que se monte la app Vue.
        var technicals_data = {{ technicals|safe }};
        var vehicles_data = {{ vehicles|safe }};
        var url_update_m2m = "{% url 'partner_add_many_to_many' %}";
        var csrf_token_m2m = "{{ csrf_token }}";
        var partner_id_m2m = "{{ partner.id }}";
    </script>
    <script src="/static/js/app/partner_app.js" defer></script>
    {% endblock %}
{% endif %}
