{% extends 'base/base.html' %}
{% load static %}
{% block style%}
<link rel="stylesheet" href="{% static 'css/app/resource_item.css' %}">
{% endblock %}
{% block content %}
<div id="resourceItemApp" class="max-w-6xl mx-auto p-6 bg-white rounded-2xl shadow-md border border-gray-300 border-t-[15px] border-t-blue-500">
  <!-- Asistente paso a paso -->
  {% verbatim %}
  <div class="wizard-container mb-6" v-if="currentStep < 3">
    <!-- Barra de progreso -->
    <div class="flex items-center justify-between mb-8">
      <template v-for="(title, index) in stepTitles" :key="index">
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 rounded-full flex items-center justify-center" 
              :class="{
                'bg-blue-500 text-white': index + 1 === currentStep,
                'bg-blue-200 text-gray-700': index + 1 < currentStep,
                'bg-gray-200 text-gray-500': index + 1 > currentStep
              }">
            {{ index + 1 }}
          </div>
          <span class="text-sm mt-1" 
                :class="{
                  'text-blue-500 font-medium': index + 1 === currentStep,
                  'text-gray-500': index + 1 !== currentStep
                }">
            {{ title }}
          </span>
        </div>
        <div v-if="index < stepTitles.length - 1" class="w-full h-1 bg-gray-200 flex-1 mx-2">
          <div class="h-full bg-blue-500" :style="{ width: index + 1 < currentStep ? '100%' : '0%' }"></div>
        </div>
      </template>
    </div>
    
    <!-- Paso 1: Selección de tipo -->
    <div v-if="currentStep === 1" class="wizard-step">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Seleccione el tipo de registro</h2>
      <p class="text-gray-600 mb-6">¿Desea registrar un equipo físico o un servicio?</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Tarjeta de Equipo -->
        <div class="card bg-gray-100 shadow-md hover:shadow-lg transition-all cursor-pointer hover:bg-blue-200 hover:border-blue-300 border-s-blue-200 border-s-5"
             @click="selectType('EQUIPO')">
          <div class="card-body">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="card-title text-lg font-bold text-blue-800">Equipo</h3>
                <p class="text-gray-600 mt-2">Seleccione esta opción para registrar un equipo físico como lavamanos, baterías sanitarias, plantas de tratamiento, etc.</p>
              </div>
              <div class="rounded-full bg-blue-100 p-3" v-if="formData.type === 'EQUIPO'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tarjeta de Servicio -->
        <div class="card bg-gray-100 shadow-md hover:shadow-lg transition-all cursor-pointer hover:bg-amber-200 hover:border-amber-300 border-s-amber-300 border-s-5"
             @click="selectType('SERVICIO')">
          <div class="card-body">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="card-title text-lg font-bold text-blue-800">Servicio</h3>
                <p class="text-gray-600 mt-2">Seleccione esta opción para registrar un servicio ofrecido como instalación, mantenimiento, transporte, etc.</p>
              </div>
              <div class="rounded-full bg-blue-100 p-3" v-if="formData.type === 'SERVICIO'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between mt-6">
        <a href="{% url 'resource_list' %}" class="btn btn-outline">Cancelar</a>
        <button class="btn btn-primary" @click.prevent="nextStep()" :disabled="!formData.type">Siguiente</button>
      </div>
    </div>
    
    <!-- Paso 2: Selección de subtipo (para equipos) -->
    <div v-if="currentStep === 2" class="wizard-step">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Seleccione el subtipo de equipo</h2>
      
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 mb-8">
        <div v-for="subtype in equipmentSubtypes" :key="subtype.value" 
             class="card bg-gray-100 shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer h-30 w-full border-s-5 border-s-blue-300 hover:bg-blue-200"
             :class="{
               'ring-2 ring-blue-400 border-blue-300 bg-blue-50': formData.subtype === subtype.value,
               'hover:border-blue-300 hover:bg-blue-50/30': formData.subtype !== subtype.value
             }"
             @click="selectSubtype(subtype.value)">
          <div class="card-body p-3 flex flex-col items-center justify-center text-center h-full">
            <!-- Icono único para todos los tipos -->
            <div class="mb-2 text-blue-600 transform transition-transform duration-300 hover:scale-110" :class="{'text-blue-800': formData.subtype === subtype.value}">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-cake">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M20.84 12c0 2.05 .985 3.225 -.04 5c-1.026 1.775 -2.537 1.51 -4.314 2.534c-1.776 1.026 -2.302 2.466 -4.353 2.466c-2.051 0 -2.576 -1.441 -4.353 -2.466c-1.776 -1.024 -3.288 -.759 -4.314 -2.534c-1.025 -1.775 -.04 -2.95 -.04 -5s-.985 -3.225 .04 -5c1.026 -1.775 2.537 -1.51 4.314 -2.534c1.776 -1.026 2.302 -2.466 4.353 -2.466s2.577 1.441 4.353 2.466c1.776 1.024 3.288 .759 4.313 2.534c1.026 1.775 .04 2.95 .04 5z" />
              </svg>
            </div>
            
            <!-- Título del subtipo -->
            <h3 class="text-sm font-medium" :class="{'text-blue-700': formData.subtype === subtype.value, 'text-gray-700': formData.subtype !== subtype.value}">{{ subtype.label }}</h3>
            
            <!-- Indicador de selección (simplificado) -->
            <div class="mt-1" v-if="formData.subtype === subtype.value">
              <span class="inline-flex items-center justify-center text-blue-700 text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between mt-6">
        <button class="btn btn-outline" @click.prevent="prevStep()">Anterior</button>
        <button class="btn btn-primary" @click.prevent="nextStep()" :disabled="!formData.subtype">Siguiente</button>
      </div>
    </div>
  </div>
  
  <!-- Paso 3: Formulario completo -->
  <div v-if="currentStep === 3" class="wizard-step">
    <!-- Vista previa del tipo seleccionado -->
    <div class="mb-6 p-4 bg-gray-100 border border-blue-200 rounded-lg">
      <div class="flex justify-between items-center">
        <div>
          <span class="font-semibold">Tipo seleccionado:</span> {{ formData.type === 'EQUIPO' ? 'Equipo' : 'Servicio' }}
          <span v-if="formData.type === 'EQUIPO'">
            - <span class="font-semibold">Subtipo:</span> {{ formData.subtype }}
          </span>
        </div>
        <button class="btn btn-sm btn-outline" @click.prevent="currentStep = 1">Cambiar</button>
      </div>
      
      <!-- Formulario Vue para Servicio -->
      <div v-if="formData.type === 'SERVICIO'" class="mt-6 p-4 bg-white border rounded-lg shadow-sm border-gray-200">
        <h3 class="text-lg font-medium text-blue-600 mb-4">Datos del Servicio</h3>
        
        <!-- Mensaje de éxito -->
        <div v-if="successMessage" class="alert alert-success mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>{{ successMessage }}</span>
        </div>
        
        <!-- Nombre del Servicio -->
        <div class="form-control mb-4" data-field="name">
          <label class="label">
            <span class="label-text font-medium">Nombre del Servicio:</span>
          </label>
          <input type="text" v-model="formData.name" class="input input-bordered w-full" placeholder="Ingrese el nombre del servicio">
          <div v-if="errors.name" class="text-error text-sm mt-1">{{ errors.name }}</div>
        </div>
        
        <!-- Nota: Estado siempre es DISPONIBLE por defecto -->
        <!-- Este comentario es solo para referencia -->
        
        <!-- Precio Base e Is Active (en una fila) -->
        <div class="flex flex-col md:flex-row gap-4 mb-4 items-end">
          <!-- Precio Base -->
          <div class="form-control flex-1" data-field="base_price">
            <label class="label">
              <span class="label-text font-medium">Precio Base:</span>
            </label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
              <input type="number" v-model="formData.base_price" class="input input-bordered w-full pl-6" placeholder="0.00" step="0.01" min="0">
            </div>
            <div v-if="errors.base_price" class="text-error text-sm mt-1">{{ errors.base_price }}</div>
          </div>

          <!-- Is Active Checkbox -->
          <div class="form-control pb-2" data-field="is_active">
            <label class="flex items-center cursor-pointer gap-3">
              <input type="checkbox" v-model="formData.is_active" class="checkbox checkbox-primary">
              <span class="label-text font-medium">Activo</span>
            </label>
            <p class="text-xs text-gray-500 mt-1">Indica si este servicio está actualmente disponible</p>
          </div>
        </div>
        
        <!-- Notas - ocupando todo el ancho -->
        <div class="form-control mb-4 w-full" data-field="notes">
          <label class="label">
            <span class="label-text font-medium">Notas:</span>
          </label>
          <textarea v-model="formData.notes" class="textarea textarea-bordered w-full" rows="4" placeholder="Ingrese notas adicionales"></textarea>
          <div v-if="errors.notes" class="text-error text-sm mt-1">{{ errors.notes }}</div>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex justify-end space-x-2 mt-6">
          <button type="button" class="btn btn-outline" @click="cancelForm">Cancelar</button>
          <button type="button" class="btn btn-primary" @click="saveService">Guardar Servicio</button>
        </div>
      </div>
      
      <!-- Formulario para Equipo con Vue.js -->
      <form v-if="formData.type === 'EQUIPO'" @submit.prevent="saveEquipment" class="mt-6">
  {% endverbatim %}
      <div class="hidden">
        {% if request.resolver_match.url_name != 'resource_create' %}    
        <a href="{% url 'resource_detail' request.resolver_match.kwargs.pk %}?action=delete" class="btn btn-sm btn-outline btn-error">
          <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
          </svg>
          Eliminar
        </a>
        <a href="{% url 'resource_detail' equipment.id %}" class="btn btn-sm btn-outline btn-info border-black">
          <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l14 0" /><path d="M5 12l6 6" /><path d="M5 12l6 -6" />
          </svg>
          Volver a Ficha
        </a>
        {% endif %}
        <a href="{% url 'resource_list' %}" class="btn btn-sm btn-outline border-black">
          <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M5.7 5.7l12.6 12.6" />
          </svg>
          Cancelar
        </a>
      </div>
    {% csrf_token %}
    
    <!-- Mostrar errores generales del formulario -->
    {% if form.errors %}
      <div class="alert alert-error mb-4">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>Por favor, corrige los errores en el formulario.</span>
        </div>
      </div>
    {% endif %}
    
    <!-- Formulario organizado en secciones -->
    <div class="w-full mb-4">
      <div class="bg-base-100 border border-base-300 rounded-lg p-6">
          <!-- Datos Principales -->
          <div class="space-y-4 border-l-blue-300 border-l-[1px] pl-5">
            <h3 class="text-lg font-medium text-blue-600 mb-4">Datos Principales</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
              <!-- Columna 1 -->
              <div>
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Código:</span>
                  </label>
                  <input type="text" v-model="formData.code" class="input input-bordered w-full" placeholder="Ingrese el código">
                  <div v-if="errors.code" class="text-error text-sm mt-1">{{ errors.code }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Marca:</span>
                  </label>
                  <input type="text" v-model="formData.brand" class="input input-bordered w-full" placeholder="Ingrese la marca">
                  <div v-if="errors.brand" class="text-error text-sm mt-1">{{ errors.brand }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Número de Serie:</span>
                  </label>
                  <input type="text" v-model="formData.serial_number" class="input input-bordered w-full" placeholder="Ingrese el número de serie">
                  <div v-if="errors.serial_number" class="text-error text-sm mt-1">{{ errors.serial_number }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Precio Base:</span>
                  </label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                    <input type="number" v-model="formData.base_price" class="input input-bordered w-full pl-6" placeholder="0.00" step="0.01" min="0">
                  </div>
                  <div v-if="errors.base_price" class="text-error text-sm mt-1">{{ errors.base_price }}</div>
                </div>
              </div>
              
              <!-- Columna 2 -->
              <div>
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Nombre:</span>
                  </label>
                  <input type="text" v-model="formData.name" class="input input-bordered w-full" placeholder="Ingrese el nombre">
                  <div v-if="errors.name" class="text-error text-sm mt-1">{{ errors.name }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Modelo:</span>
                  </label>
                  <input type="text" v-model="formData.model" class="input input-bordered w-full" placeholder="Ingrese el modelo">
                  <div v-if="errors.model" class="text-error text-sm mt-1">{{ errors.model }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Fecha de Compra:</span>
                  </label>
                  <input type="date" v-model="formData.date_purchase" class="input input-bordered w-full">
                  <div v-if="errors.date_purchase" class="text-error text-sm mt-1">{{ errors.date_purchase }}</div>
                </div>
                
                <div class="form-control mb-3">
                  <label class="label">
                    <span class="label-text">Estado:</span>
                  </label>
                  <select v-model="formData.status" class="select select-bordered w-full">
                    <option value="DISPONIBLE">Disponible</option>
                    <option value="RENTADO">Rentado</option>
                    <option value="EN_REPARACION">En Reparación</option>
                    <option value="FUERA_DE_SERVICIO">Fuera de Servicio</option>
                  </select>
                  <div v-if="errors.status" class="text-error text-sm mt-1">{{ errors.status }}</div>
                </div>
              </div>
            </div>

            <div class="form-control" v-if="formData.status === 'EN_REPARACION'">
              <label class="label">
                <span class="label-text">Motivo de Reparación:</span>
              </label>
              <textarea v-model="formData.motivo_reparacion" class="textarea textarea-bordered w-full" rows="3" placeholder="Ingrese el motivo de la reparación"></textarea>
              <div v-if="errors.motivo_reparacion" class="text-error text-sm mt-1">{{ errors.motivo_reparacion }}</div>
            </div>

            <div class="form-control">
              <label class="flex items-center cursor-pointer gap-3">
                <input type="checkbox" v-model="formData.is_active" class="checkbox checkbox-primary">
                <span class="label-text font-medium">Activo</span>
              </label>
              <p class="text-xs text-gray-500 mt-1">Indica si el equipo está activo y disponible</p>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Estado Físico:</span>
              </label>
              {{ form.status }}
              {% if form.status.errors %}
                <div class="label">
                  <span class="label-text-alt text-error">{{ form.status.errors.0 }}</span>
                </div>
              {% endif %}
            </div>

            <!-- Motivo de reparación (aparece cuando status es EN REPARACION) -->
            <div class="form-control" id="motivo_reparacion_div" style="display: none;">
              <label class="label">
                <span class="label-text">Motivo de Reparación:</span>
              </label>
              {{ form.motivo_reparacion }}
              {% if form.motivo_reparacion.errors %}
                <div class="label">
                  <span class="label-text-alt text-error">{{ form.motivo_reparacion.errors.0 }}</span>
                </div>
              {% endif %}
            </div>
          </div>

        <!-- Dimensiones y Peso -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 class="text-lg font-medium text-blue-600 mb-4">Dimensiones y Peso</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-control">
              <label class="label">
                <span class="label-text">Alto (cm):</span>
              </label>
              <input type="number" v-model="formData.height" class="input input-bordered w-full" step="0.01" min="0" placeholder="0.00">
              <div v-if="errors.height" class="text-error text-sm mt-1">{{ errors.height }}</div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Ancho (cm):</span>
              </label>
              <input type="number" v-model="formData.width" class="input input-bordered w-full" step="0.01" min="0" placeholder="0.00">
              <div v-if="errors.width" class="text-error text-sm mt-1">{{ errors.width }}</div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Profundidad (cm):</span>
              </label>
              <input type="number" v-model="formData.depth" class="input input-bordered w-full" step="0.01" min="0" placeholder="0.00">
              <div v-if="errors.depth" class="text-error text-sm mt-1">{{ errors.depth }}</div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Peso (kg):</span>
              </label>
              <input type="number" v-model="formData.weight" class="input input-bordered w-full" step="0.01" min="0" placeholder="0.00">
              <div v-if="errors.weight" class="text-error text-sm mt-1">{{ errors.weight }}</div>
            </div>
          </div>
        </div>

        <!-- Características Específicas por Subtipo -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200" id="caracteristicas_section" style="display: none;">
          <h3 class="text-lg font-medium text-blue-600 mb-4">Características Específicas</h3>
          
          <!-- Características para Lavamanos -->
          <div id="lavamanos_caracteristicas" class="caracteristicas-group" style="display: none;">
            <h4 class="font-medium text-gray-700 mb-4">Características de Lavamanos</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.bombas_pie }}
                  <span class="label-text">Bombas de Pie</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.dispensador_jabon_lavamanos }}
                  <span class="label-text">Dispensador de Jabón</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Características para Baterías Sanitarias -->
          <div id="bateria_caracteristicas" class="caracteristicas-group" style="display: none;">
            <h4 class="font-medium text-gray-700 mb-4">Características de Batería Sanitaria</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.dispensador_papel }}
                  <span class="label-text">Dispensador de Papel</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.dispensador_jabon }}
                  <span class="label-text">Dispensador de Jabón</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.dispensador_servilletas }}
                  <span class="label-text">Dispensador de Servilletas</span>
                </label>
              </div>
              <div class="form-control" id="urinales_field">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.urinales }}
                  <span class="label-text">Urinales</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.asientos }}
                  <span class="label-text">Asientos</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.bomba_bano }}
                  <span class="label-text">Bomba Baño</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.bomba_lavamanos }}
                  <span class="label-text">Bomba Lavamanos</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.tapa_inodoro }}
                  <span class="label-text">Tapa de Inodoro</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.bases_banos }}
                  <span class="label-text">Bases Baños</span>
                </label>
              </div>
              <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                  {{ form.tubo_ventilacion }}
                  <span class="label-text">Tubo de Ventilación</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Notas -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h3 class="text-lg font-medium text-blue-600 mb-4">Notas y Observaciones</h3>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text">Notas:</span>
            </label>
            {{ form.notes }}
            {% if form.notes.errors %}
              <div class="label">
                <span class="label-text-alt text-error">{{ form.notes.errors.0 }}</span>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% verbatim %}
  <!-- Botones de acción -->
    <div class="flex flex-wrap justify-center gap-2 mt-6 border-t pt-4">
      <button type="submit" class="btn btn-primary" :disabled="isSaving">
        <svg v-if="isSaving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <svg v-else xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M5 12l5 5l10 -10" />
        </svg>
        <span v-if="isSaving">Guardando...</span>
        <span v-else>Guardar Equipo</span>
      </button>
  {% endverbatim %}
      
      <button type="button" @click="cancelForm" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M5 12l14 0" />
          <path d="M5 12l6 6" />
          <path d="M5 12l6 -6" />
        </svg>
        Cancelar
      </button>
      
      {% verbatim %}
      <div v-if="successMessage" class="alert alert-success mt-4">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ successMessage }}</span>
        </div>
      </div>
      
      <div v-if="Object.keys(errors).length > 0" class="alert alert-error mt-4 w-full">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="font-bold">¡Error al guardar el equipo!</h3>
            <div class="text-xs">
              <p v-for="(error, field) in errors" :key="field" class="mt-1">
                <strong>{{ field | capitalize }}:</strong> {{ error }}
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endverbatim %}
      
      {% if request.resolver_match.url_name != 'resource_create' %}
        <a :href="'{% url 'resource_detail' '0' %}'.replace('0', formData.id)" class="btn btn-outline">
          <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M9 6l-6 6l6 6" />
          </svg>
          Ver Detalle
        </a>
      {% endif %}
      
      <a href="{% url 'resource_list' %}" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M9 6l-6 6l6 6" />
        </svg>
        Cancelar
      </a>
    </div>
  </form>
  </div>
</div>
{% block script_app %}
<script>
// Add saveEquipment method to the Vue app
if (typeof ResourceItemApp !== 'undefined') {
  ResourceItemApp.methods.saveEquipment = async function() {
    this.isSaving = true;
    this.errors = {};
    
    try {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const url = this.formData.id 
        ? `/api/resource/equipment/${this.formData.id}/` 
        : '/api/resource/equipment/';
      
      const method = this.formData.id ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(this.formData)
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        if (response.status === 400) {
          this.errors = data;
          this.scrollToError();
        } else {
          throw new Error(data.detail || 'Error al guardar el equipo');
        }
      } else {
        this.successMessage = '¡Equipo guardado exitosamente!';
        
        // Update form data with the response (in case of new IDs, etc.)
        this.formData = { ...this.formData, ...data };
        
        // If this was a new item, update the URL
        if (!this.formData.id && data.id) {
          window.history.pushState({}, '', `/equipment/edit/${data.id}/`);
        }
        
        // Scroll to success message
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    } catch (error) {
      console.error('Error saving equipment:', error);
      this.errors = { general: error.message };
      this.scrollToError();
    } finally {
      this.isSaving = false;
    }
  };
  
  // Add helper method to scroll to first error
  ResourceItemApp.methods.scrollToError = function() {
    this.$nextTick(() => {
      const firstError = document.querySelector('.text-error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  };
  
  // Add isSaving flag to data
  if (ResourceItemApp.data) {
    const originalData = ResourceItemApp.data();
    ResourceItemApp.data = function() {
      return {
        ...originalData,
        isSaving: false
      };
    };
  }
  
  // Add filter to capitalize field names
  ResourceItemApp.filters = {
    capitalize: function(value) {
      if (!value) return '';
      value = value.toString();
      return value.charAt(0).toUpperCase() + value.slice(1).replace(/_/g, ' ');
    }
  };
}
</script>
<script src="{% static 'js/app/resourceitem_app.js' %}"></script>
{% endblock %}
{% endblock %}