{% extends 'base/base.html'%}
{% load static %}

{% block content %}
<div class="p-4 sm:p-6 lg:p-8 space-y-6">
  <div class="tabs tabs-boxed">
    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Calendario Mantenimientos" checked />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      
      <!-- Controles de Navegación -->
      <div class="bg-gray-100 rounded-lg p-4 shadow border border-gray-200">
        <div class="flex items-center justify-between">
          <!-- Botón Anterior -->
          <a href="?month_offset={{ calendar.month_offset|add:'-1' }}" 
             class="btn btn-circle btn-sm bg-white text-gray-600 hover:bg-gray-50 border-gray-300">
            <i class="las la-chevron-left text-xl"></i>
          </a>

          <!-- Información del Período -->
          <div class="text-center flex-1">
            <h2 class="text-gray-800 font-bold text-xl capitalize">
              {{ calendar.month_name }} {{ calendar.year }}
            </h2>
            
            {% if calendar.month_offset != 0 %}
            <a href="?month_offset=0" class="btn btn-xs bg-white text-gray-600 hover:bg-gray-50 border-gray-300 mt-2">
              <i class="las la-calendar-day"></i>
              Mes Actual
            </a>
            {% endif %}
          </div>

          <!-- Botón Siguiente -->
          <a href="?month_offset={{ calendar.month_offset|add:'1' }}" 
             class="btn btn-circle btn-sm bg-white text-gray-600 hover:bg-gray-50 border-gray-300">
            <i class="las la-chevron-right text-xl"></i>
          </a>
        </div>

        <!-- Resumen Rápido -->
        <div class="grid grid-cols-4 gap-4 mt-4">
          <div class="bg-white rounded-lg p-3 text-center border border-gray-200">
            <p class="text-gray-500 text-xs">Mantenimientos</p>
            <p class="text-gray-800 font-bold text-2xl">{{ calendar.summary.total_maintenances }}</p>
          </div>
          <div class="bg-white rounded-lg p-3 text-center border border-gray-200">
            <p class="text-gray-500 text-xs">Recursos</p>
            <p class="text-gray-800 font-bold text-2xl">{{ calendar.summary.resources_count }}</p>
          </div>
          <div class="bg-white rounded-lg p-3 text-center border border-gray-200">
            <p class="text-gray-500 text-xs">Proyectos</p>
            <p class="text-gray-800 font-bold text-2xl">{{ calendar.summary.projects_count }}</p>
          </div>
          <div class="bg-white rounded-lg p-3 text-center border border-gray-200">
            <p class="text-gray-500 text-xs">Costo Total</p>
            <p class="text-gray-800 font-bold text-lg">Q{{ calendar.summary.total_cost|floatformat:2 }}</p>
          </div>
        </div>

        <!-- Leyenda de Frecuencias -->
        <div class="flex justify-center gap-4 mt-4">
          <div class="flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
            <span class="text-gray-700 text-xs">Intervalo días</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-purple-500"></span>
            <span class="text-gray-700 text-xs">Días semana</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-orange-500"></span>
            <span class="text-gray-700 text-xs">Días mes</span>
          </div>
        </div>
      </div>

      <!-- Calendario Visual del Mes -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Encabezado de días de la semana -->
        <div class="grid grid-cols-7 bg-gray-100">
          {% for day_name in calendar.weekdays %}
          <div class="p-2 text-center text-sm font-semibold text-gray-700 border-r border-gray-200 last:border-r-0">
            {{ day_name }}
          </div>
          {% endfor %}
        </div>

        <!-- Semanas del mes -->
        {% for week in calendar.weeks %}
        <div class="grid grid-cols-7 border-t border-gray-200">
          {% for day_info in week %}
          <div class="min-h-24 p-1 border-r border-gray-200 last:border-r-0 transition-colors
            {% if not day_info %}bg-gray-50
            {% elif day_info.has_maintenances %}bg-lime-50 hover:bg-lime-100 cursor-pointer
            {% else %}bg-white{% endif %}
            {% if day_info.is_today %}ring-2 ring-lime-500 ring-inset{% endif %}"
            {% if day_info.has_maintenances %}onclick="showDayDetails('{{ day_info.date }}')"{% endif %}>
            
            {% if day_info %}
            <!-- Número del día -->
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium 
                {% if day_info.is_today %}text-lime-700
                {% elif day_info.has_maintenances %}text-gray-700
                {% else %}text-gray-400{% endif %}">
                {{ day_info.day }}
              </span>
              {% if day_info.has_maintenances %}
              <span class="badge badge-xs badge-success">{{ day_info.count }}</span>
              {% endif %}
            </div>

            <!-- Indicadores de mantenimientos (máximo 3 visibles) -->
            {% if day_info.has_maintenances %}
            <div class="space-y-0.5">
              {% for m in day_info.maintenances|slice:":3" %}
              <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full flex-shrink-0
                  {% if m.frequency_type == 'DAY' %}bg-blue-500
                  {% elif m.frequency_type == 'WEEK' %}bg-purple-500
                  {% elif m.frequency_type == 'MONTH' %}bg-orange-500
                  {% else %}bg-gray-500{% endif %}"></span>
                <span class="text-xs truncate text-gray-600" title="{{ m.project_name }} - {{ m.project_location }}{% if m.project_cardinal %} {{ m.project_cardinal }}{% endif %}">
                  {{ m.code }} <span class="text-gray-400">| {{ m.project_name|truncatechars:10 }}</span>
                </span>
              </div>
              {% endfor %}
              {% if day_info.count > 3 %}
              <div class="text-xs text-gray-500 pl-3">+{{ day_info.count|add:"-3" }} más</div>
              {% endif %}
            </div>
            {% endif %}
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>

      <!-- Panel de Detalles del Día (oculto por defecto) -->
      <div id="day-details-panel" class="hidden bg-white rounded-lg shadow-lg p-4 border-l-4 border-lime-500">
        <div class="flex items-center justify-between mb-4">
          <h3 id="day-details-title" class="text-lg font-semibold text-gray-700">
            <i class="las la-calendar-check text-lime-600"></i>
            Mantenimientos del día
          </h3>
          <button onclick="hideDayDetails()" class="btn btn-circle btn-sm btn-ghost">
            <i class="las la-times"></i>
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-xs">Proyecto / Ubicación</th>
                <th class="text-xs">Código</th>
                <th class="text-xs">Recurso</th>
                <th class="text-xs">Frecuencia</th>
                <th class="text-xs text-right">Costo</th>
              </tr>
            </thead>
            <tbody id="day-details-body">
              <!-- Se llena dinámicamente -->
            </tbody>
            <tfoot>
              <tr class="bg-gray-100 font-semibold">
                <td colspan="4" class="text-right text-xs">Total del día:</td>
                <td id="day-details-total" class="text-right text-xs">Q0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      {% if calendar.summary.total_maintenances == 0 %}
      <div class="alert alert-info">
        <i class="las la-info-circle text-2xl"></i>
        <span>No hay mantenimientos programados para este mes.</span>
      </div>
      {% endif %}
    </div>

    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Alertas del sistema" />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      <!-- Resumen de alertas -->
      <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
        <div class="stat">
          <div class="stat-title">Total Alertas</div>
          <div class="stat-value">{{ alerts.total }}</div>
          <div class="stat-desc">Sistema completo</div>
        </div>
        <div class="stat">
          <div class="stat-title">Vencidos</div>
          <div class="stat-value text-error">{{ alerts.total_expired }}</div>
          <div class="stat-desc">Requiere atención inmediata</div>
        </div>
        <div class="stat">
          <div class="stat-title">Por vencer (10 días)</div>
          <div class="stat-value text-warning">{{ alerts.total_due_10 }}</div>
          <div class="stat-desc">Alta prioridad</div>
        </div>
        <div class="stat">
          <div class="stat-title">Por vencer (30 días)</div>
          <div class="stat-value text-info">{{ alerts.total_due_30 }}</div>
          <div class="stat-desc">Prioridad normal</div>
        </div>
      </div>

      <!-- Alertas vencidas -->
      {% if alerts.expired %}
      <div class="alert alert-error shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-triangle text-2xl"></i>
            <h3 class="font-semibold">Elementos Vencidos ({{ alerts.total_expired }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('expired')" class="btn btn-sm btn-ghost">
              <i id="icon-expired" class="las la-eye text-lg"></i>
              <span id="text-expired">Mostrar</span>
            </button>
            <div id="buttons-expired" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-expired" class="overflow-x-auto" style="display: none;">
        <table id="table-expired" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días vencido</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.expired %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_expired_abs }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Alertas por vencer en 10 días -->
      {% if alerts.due_10 %}
      <div class="alert alert-warning shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-circle text-2xl"></i>
            <h3 class="font-semibold">Por vencer en 10 días o menos ({{ alerts.total_due_10 }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('due-10')" class="btn btn-sm btn-ghost">
              <i id="icon-due-10" class="las la-eye text-lg"></i>
              <span id="text-due-10">Mostrar</span>
            </button>
            <div id="buttons-due-10" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-due-10" class="overflow-x-auto" style="display: none;">
        <table id="table-due-10" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días restantes</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.due_10 %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_left }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Alertas por vencer en 30 días -->
      {% if alerts.due_30 %}
      <div class="alert alert-info shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-info-circle text-2xl"></i>
            <h3 class="font-semibold">Por vencer en 30 días o menos ({{ alerts.total_due_30 }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('due-30')" class="btn btn-sm btn-ghost">
              <i id="icon-due-30" class="las la-eye text-lg"></i>
              <span id="text-due-30">Mostrar</span>
            </button>
            <div id="buttons-due-30" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-due-30" class="overflow-x-auto" style="display: none;">
        <table id="table-due-30" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días restantes</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.due_30 %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_left }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Sin alertas -->
      {% if alerts.total == 0 %}
      <div class="alert alert-success shadow-lg">
        <div class="flex-1">
          <i class="las la-check-circle text-2xl"></i>
          <h3 class="font-semibold">No hay alertas activas</h3>
          <p class="text-sm">Todos los certificados, licencias y documentos están al día.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Estado de Recursos" />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      <!-- Resumen de recursos -->
      <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
        <div class="stat">
          <div class="stat-title">Total Equipos</div>
          <div class="stat-value">{{ equipment_status.total }}</div>
          <div class="stat-desc">Equipos registrados</div>
        </div>
        <div class="stat">
          <div class="stat-title">Disponibles</div>
          <div class="stat-value text-success">{{ equipment_status.total_available }}</div>
          <div class="stat-desc">Listos para rentar</div>
        </div>
        <div class="stat">
          <div class="stat-title">Rentados</div>
          <div class="stat-value text-info">{{ equipment_status.total_rented }}</div>
          <div class="stat-desc">En proyectos activos</div>
        </div>
        <div class="stat">
          <div class="stat-title">Incompletos</div>
          <div class="stat-value text-warning">{{ equipment_status.total_incomplete }}</div>
          <div class="stat-desc">Falta checklist</div>
        </div>
        <div class="stat">
          <div class="stat-title">Con Problemas</div>
          <div class="stat-value text-error">{{ equipment_status.total_with_issues }}</div>
          <div class="stat-desc">Inconsistencias detectadas</div>
        </div>
      </div>

      <!-- Equipos con inconsistencias -->
      {% if equipment_status.with_issues %}
      <div class="alert alert-error shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-triangle text-2xl"></i>
            <h3 class="font-semibold">Equipos con Inconsistencias ({{ equipment_status.total_with_issues }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('equipment-issues')" class="btn btn-sm btn-ghost">
              <i id="icon-equipment-issues" class="las la-eye text-lg"></i>
              <span id="text-equipment-issues">Mostrar</span>
            </button>
            <div id="buttons-equipment-issues" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-equipment-issues" class="overflow-x-auto" style="display: none;">
        <table id="table-equipment-issues" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Problemas</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.with_issues %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>
                {% if item.availability_status == 'DISPONIBLE' %}
                Disponible
                {% elif item.availability_status == 'RENTADO' %}
                Rentado
                {% endif %}
              </td>
              <td>
                {% for issue in item.report.inconsistencies.found %}
                {{ issue.description }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Equipos incompletos -->
      {% if equipment_status.incomplete %}
      <div class="alert alert-warning shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-clipboard-list text-2xl"></i>
            <h3 class="font-semibold">Equipos Incompletos ({{ equipment_status.total_incomplete }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('equipment-incomplete')" class="btn btn-sm btn-ghost">
              <i id="icon-equipment-incomplete" class="las la-eye text-lg"></i>
              <span id="text-equipment-incomplete">Mostrar</span>
            </button>
            <div id="buttons-equipment-incomplete" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-equipment-incomplete" class="overflow-x-auto" style="display: none;">
        <table id="table-equipment-incomplete" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Completitud %</th>
              <th>Elementos Faltantes</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.incomplete %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>{{ item.completion_percentage|floatformat:0 }}%</td>
              <td>{{ item.missing_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Equipos rentados -->
      {% if equipment_status.rented %}
      <div class="alert alert-info shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-handshake text-2xl"></i>
            <h3 class="font-semibold">Equipos Rentados ({{ equipment_status.total_rented }})</h3>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="toggleTable('equipment-rented')" class="btn btn-sm btn-ghost">
              <i id="icon-equipment-rented" class="las la-eye text-lg"></i>
              <span id="text-equipment-rented">Mostrar</span>
            </button>
            <div id="buttons-equipment-rented" class="flex gap-1"></div>
          </div>
        </div>
      </div>
      <div id="table-container-equipment-rented" class="overflow-x-auto" style="display: none;">
        <table id="table-equipment-rented" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Cliente</th>
              <th>Ubicación</th>
              <th>Fecha Liberación</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.rented %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>
                {% if item.report.rental_info %}
                  {{ item.report.rental_info.project_partner }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if item.report.availability.current_location %}
                  {{ item.report.availability.current_location }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if item.report.availability.release_date %}
                  {{ item.report.availability.release_date|date:"d/m/Y" }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Todo OK -->
      {% if equipment_status.total == 0 %}
      <div class="alert alert-info shadow-lg">
        <div class="flex-1">
          <i class="las la-info-circle text-2xl"></i>
          <h3 class="font-semibold">No hay equipos registrados</h3>
          <p class="text-sm">Comienza registrando equipos en el sistema.</p>
        </div>
      </div>
      {% elif equipment_status.total_with_issues == 0 and equipment_status.total_incomplete == 0 %}
      <div class="alert alert-success shadow-lg">
        <div class="flex-1">
          <i class="las la-check-circle text-2xl"></i>
          <h3 class="font-semibold">Todos los equipos están en orden</h3>
          <p class="text-sm">No hay inconsistencias ni equipos incompletos.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block script_app %}
<script>
// Variable para controlar qué tabla está visible
let currentVisibleTable = null;

// Función para mostrar/ocultar tablas
function toggleTable(tableId) {
    const container = document.getElementById('table-container-' + tableId);
    const icon = document.getElementById('icon-' + tableId);
    const text = document.getElementById('text-' + tableId);
    
    // Si esta tabla ya está visible, la ocultamos
    if (currentVisibleTable === tableId) {
        container.style.display = 'none';
        icon.className = 'las la-eye text-lg';
        text.textContent = 'Mostrar';
        currentVisibleTable = null;
        return;
    }
    
    // Ocultar la tabla actualmente visible (si hay una)
    if (currentVisibleTable) {
        const currentContainer = document.getElementById('table-container-' + currentVisibleTable);
        const currentIcon = document.getElementById('icon-' + currentVisibleTable);
        const currentText = document.getElementById('text-' + currentVisibleTable);
        
        currentContainer.style.display = 'none';
        currentIcon.className = 'las la-eye text-lg';
        currentText.textContent = 'Mostrar';
    }
    
    // Mostrar la tabla seleccionada
    container.style.display = 'block';
    icon.className = 'las la-eye-slash text-lg';
    text.textContent = 'Ocultar';
    currentVisibleTable = tableId;
    
    // Inicializar DataTable si no se ha hecho ya
    if (!$.fn.DataTable.isDataTable('#table-' + tableId)) {
        const titles = {
            'expired': 'Elementos Vencidos',
            'due-10': 'Por Vencer 10 Días',
            'due-30': 'Por Vencer 30 Días',
            'equipment-issues': 'Equipos con Inconsistencias',
            'equipment-incomplete': 'Equipos Incompletos',
            'equipment-rented': 'Equipos Rentados'
        };
        
        initializeDataTable('table-' + tableId, 'buttons-' + tableId, titles[tableId]);
    }
}

$(document).ready(function() {
    // Función para inicializar DataTables con botones de exportación
    function initializeDataTable(tableId, containerId, title) {
        var table = $('#' + tableId);
        
        // Verificar si la tabla existe y tiene datos
        if (table.length && table.find('tbody tr').length > 0) {
            var dataTable = table.DataTable({
                language: {
                    url: "{% static 'i18n/es-ES.json' %}"
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="las la-file-excel text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="las la-file-pdf text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    },
                    {
                        extend: 'csv',
                        text: '<i class="las la-file-csv text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    }
                ],
                lengthMenu: [
                    [15, 50, 100, -1],
                    ['15', '50', '100', 'Todos']
                ],
                pageLength: 15,
                searching: false,
                lengthChange: false,
                info: false,
                paging: false
            });
            
            // Mover los botones al contenedor específico
            var buttons = dataTable.buttons().container();
            buttons.appendTo('#' + containerId);
        }
    }
    
    // Hacer la función disponible globalmente
    window.initializeDataTable = initializeDataTable;
});

// Datos de mantenimientos por fecha (generados por Django)
const maintenanceByDate = {{ calendar.maintenance_by_date_json|safe }};

// Mostrar detalles del día
function showDayDetails(dateStr) {
    const panel = document.getElementById('day-details-panel');
    const title = document.getElementById('day-details-title');
    const tbody = document.getElementById('day-details-body');
    const totalCell = document.getElementById('day-details-total');
    
    const maintenances = maintenanceByDate[dateStr] || [];
    
    if (maintenances.length === 0) {
        return;
    }
    
    // Formatear fecha para el título
    const dateObj = new Date(dateStr + 'T00:00:00');
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const formattedDate = dateObj.toLocaleDateString('es-GT', options);
    
    title.innerHTML = `<i class="las la-calendar-check text-lime-600"></i> Mantenimientos del ${formattedDate}`;
    
    // Generar filas de la tabla
    let html = '';
    let total = 0;
    
    maintenances.forEach(m => {
        const freqColor = m.frequency_type === 'DAY' ? 'badge-primary' : 
                         m.frequency_type === 'WEEK' ? 'badge-secondary' : 'badge-accent';
        const freqLabel = m.frequency_type === 'DAY' ? 
                         (m.interval_days === 0 ? 'Diario' : `Cada ${m.interval_days} días`) :
                         m.frequency_type === 'WEEK' ? 'Semanal' : 'Mensual';
        
        // Construir ubicación con cardinal point
        let ubicacion = m.project_location || '';
        if (m.project_cardinal) {
            ubicacion += ubicacion ? ` - ${m.project_cardinal}` : m.project_cardinal;
        }
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="text-xs">
                    <a href="/proyectos/projects/${m.project_id}/" class="font-medium text-blue-600 hover:underline">
                        <i class="las la-external-link-alt"></i> ${m.project_name}
                    </a>
                    <br><span class="text-gray-500">${ubicacion || '-'}</span>
                </td>
                <td class="text-xs">
                    <span class="badge badge-outline badge-sm">${m.code}</span>
                    <br><span class="text-gray-500 text-xs">${m.description || ''}</span>
                </td>
                <td class="text-xs font-medium">${m.name}</td>
                <td class="text-xs">
                    <span class="badge badge-sm ${freqColor}">${freqLabel}</span>
                </td>
                <td class="text-xs text-right font-semibold">Q${m.cost.toFixed(2)}</td>
            </tr>
        `;
        total += m.cost;
    });
    
    tbody.innerHTML = html;
    totalCell.textContent = `Q${total.toFixed(2)}`;
    
    // Mostrar panel
    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Ocultar detalles del día
function hideDayDetails() {
    document.getElementById('day-details-panel').classList.add('hidden');
}
</script>
{% endblock %}