{% extends 'base/base.html'%}
{% load static %}

{% block content %}
<div class="p-4 sm:p-6 lg:p-8 space-y-6">
  <div class="tabs tabs-boxed">
    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Planificación del día" checked />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      <div class="alert alert-info">
        <div class="flex-1">
          <h3 class="font-semibold">Agenda pendiente</h3>
          <p class="text-sm">Aquí listaremos tareas, asignaciones y mantenimientos del día.</p>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        <div class="card bg-base-200 border border-base-300">
          <div class="card-body">
            <h2 class="card-title text-base-content/80">Actividades</h2>
            <p class="text-sm text-base-content/70">Próximamente: bloque de actividades programadas.</p>
          </div>
        </div>
        <div class="card bg-base-200 border border-base-300">
          <div class="card-body">
            <h2 class="card-title text-base-content/80">Asignaciones</h2>
            <p class="text-sm text-base-content/70">Próximamente: técnicos, vehículos y recursos asignados.</p>
          </div>
        </div>
        <div class="card bg-base-200 border border-base-300">
          <div class="card-body">
            <h2 class="card-title text-base-content/80">Logística</h2>
            <p class="text-sm text-base-content/70">Próximamente: rutas, entregas y movimientos.</p>
          </div>
        </div>
      </div>
    </div>

    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Alertas del sistema" />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      <!-- Resumen de alertas -->
      <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
        <div class="stat">
          <div class="stat-title">Total Alertas</div>
          <div class="stat-value">{{ alerts.total }}</div>
          <div class="stat-desc">Sistema completo</div>
        </div>
        <div class="stat">
          <div class="stat-title">Vencidos</div>
          <div class="stat-value text-error">{{ alerts.total_expired }}</div>
          <div class="stat-desc">Requiere atención inmediata</div>
        </div>
        <div class="stat">
          <div class="stat-title">Por vencer (10 días)</div>
          <div class="stat-value text-warning">{{ alerts.total_due_10 }}</div>
          <div class="stat-desc">Alta prioridad</div>
        </div>
        <div class="stat">
          <div class="stat-title">Por vencer (30 días)</div>
          <div class="stat-value text-info">{{ alerts.total_due_30 }}</div>
          <div class="stat-desc">Prioridad normal</div>
        </div>
      </div>

      <!-- Alertas vencidas -->
      {% if alerts.expired %}
      <div class="alert alert-error shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-triangle text-2xl"></i>
            <h3 class="font-semibold">Elementos Vencidos ({{ alerts.total_expired }})</h3>
          </div>
          <div id="buttons-expired" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-expired" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días vencido</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.expired %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_expired_abs }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Alertas por vencer en 10 días -->
      {% if alerts.due_10 %}
      <div class="alert alert-warning shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-circle text-2xl"></i>
            <h3 class="font-semibold">Por vencer en 10 días o menos ({{ alerts.total_due_10 }})</h3>
          </div>
          <div id="buttons-due-10" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-due-10" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días restantes</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.due_10 %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_left }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Alertas por vencer en 30 días -->
      {% if alerts.due_30 %}
      <div class="alert alert-info shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-info-circle text-2xl"></i>
            <h3 class="font-semibold">Por vencer en 30 días o menos ({{ alerts.total_due_30 }})</h3>
          </div>
          <div id="buttons-due-30" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-due-30" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Identificación</th>
              <th>Días restantes</th>
              <th>Fecha vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in alerts.due_30 %}
            <tr>
              <td>
                {% if issue.technical_id %}
                <span class="badge badge-primary">Técnico</span>
                {% elif issue.vehicle_id %}
                <span class="badge badge-secondary">Vehículo</span>
                {% endif %}
              </td>
              <td>{{ issue.label }}</td>
              <td>
                {% if issue.technical_name %}
                  {{ issue.technical_name }}
                {% elif issue.vehicle_plate %}
                  {{ issue.vehicle_plate }}
                {% endif %}
              </td>
              <td>{{ issue.days_left }} días</td>
              <td>{{ issue.expires_on|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Sin alertas -->
      {% if alerts.total == 0 %}
      <div class="alert alert-success shadow-lg">
        <div class="flex-1">
          <i class="las la-check-circle text-2xl"></i>
          <h3 class="font-semibold">No hay alertas activas</h3>
          <p class="text-sm">Todos los certificados, licencias y documentos están al día.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <input type="radio" name="tab-home" role="tab" class="tab" aria-label="Estado de Recursos" />
    <div role="tabpanel" class="tab-content bg-base-100 border border-base-300 rounded-xl shadow-sm p-4 space-y-4">
      <!-- Resumen de recursos -->
      <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
        <div class="stat">
          <div class="stat-title">Total Equipos</div>
          <div class="stat-value">{{ equipment_status.total }}</div>
          <div class="stat-desc">Equipos registrados</div>
        </div>
        <div class="stat">
          <div class="stat-title">Disponibles</div>
          <div class="stat-value text-success">{{ equipment_status.total_available }}</div>
          <div class="stat-desc">Listos para rentar</div>
        </div>
        <div class="stat">
          <div class="stat-title">Rentados</div>
          <div class="stat-value text-info">{{ equipment_status.total_rented }}</div>
          <div class="stat-desc">En proyectos activos</div>
        </div>
        <div class="stat">
          <div class="stat-title">Incompletos</div>
          <div class="stat-value text-warning">{{ equipment_status.total_incomplete }}</div>
          <div class="stat-desc">Falta checklist</div>
        </div>
        <div class="stat">
          <div class="stat-title">Con Problemas</div>
          <div class="stat-value text-error">{{ equipment_status.total_with_issues }}</div>
          <div class="stat-desc">Inconsistencias detectadas</div>
        </div>
      </div>

      <!-- Equipos con inconsistencias -->
      {% if equipment_status.with_issues %}
      <div class="alert alert-error shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-exclamation-triangle text-2xl"></i>
            <h3 class="font-semibold">Equipos con Inconsistencias ({{ equipment_status.total_with_issues }})</h3>
          </div>
          <div id="buttons-equipment-issues" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-equipment-issues" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Problemas</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.with_issues %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>
                {% if item.availability_status == 'DISPONIBLE' %}
                Disponible
                {% elif item.availability_status == 'RENTADO' %}
                Rentado
                {% endif %}
              </td>
              <td>
                {% for issue in item.report.inconsistencies.found %}
                {{ issue.description }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Equipos incompletos -->
      {% if equipment_status.incomplete %}
      <div class="alert alert-warning shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-clipboard-list text-2xl"></i>
            <h3 class="font-semibold">Equipos Incompletos ({{ equipment_status.total_incomplete }})</h3>
          </div>
          <div id="buttons-equipment-incomplete" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-equipment-incomplete" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Completitud %</th>
              <th>Elementos Faltantes</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.incomplete %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>{{ item.completion_percentage|floatformat:0 }}%</td>
              <td>{{ item.missing_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Equipos rentados -->
      {% if equipment_status.rented %}
      <div class="alert alert-info shadow-lg">
        <div class="flex justify-between items-center">
          <div class="flex gap-3">
            <i class="las la-handshake text-2xl"></i>
            <h3 class="font-semibold">Equipos Rentados ({{ equipment_status.total_rented }})</h3>
          </div>
          <div id="buttons-equipment-rented" class="flex gap-1"></div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="table-equipment-rented" class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Cliente</th>
              <th>Ubicación</th>
              <th>Fecha Liberación</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_status.rented %}
            <tr>
              <td>{{ item.equipment.code }}</td>
              <td>{{ item.equipment.name }}</td>
              <td>{{ item.equipment.get_type_equipment_display }}</td>
              <td>
                {% if item.report.rental_info %}
                  {{ item.report.rental_info.project_partner }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if item.report.availability.current_location %}
                  {{ item.report.availability.current_location }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if item.report.availability.release_date %}
                  {{ item.report.availability.release_date|date:"d/m/Y" }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Todo OK -->
      {% if equipment_status.total == 0 %}
      <div class="alert alert-info shadow-lg">
        <div class="flex-1">
          <i class="las la-info-circle text-2xl"></i>
          <h3 class="font-semibold">No hay equipos registrados</h3>
          <p class="text-sm">Comienza registrando equipos en el sistema.</p>
        </div>
      </div>
      {% elif equipment_status.total_with_issues == 0 and equipment_status.total_incomplete == 0 %}
      <div class="alert alert-success shadow-lg">
        <div class="flex-1">
          <i class="las la-check-circle text-2xl"></i>
          <h3 class="font-semibold">Todos los equipos están en orden</h3>
          <p class="text-sm">No hay inconsistencias ni equipos incompletos.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block script_app %}
<script>
$(document).ready(function() {
    // Función para inicializar DataTables con botones de exportación
    function initializeDataTable(tableId, containerId, title) {
        var table = $('#' + tableId);
        
        // Verificar si la tabla existe y tiene datos
        if (table.length && table.find('tbody tr').length > 0) {
            var dataTable = table.DataTable({
                language: {
                    url: "{% static 'i18n/es-ES.json' %}"
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="las la-file-excel text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="las la-file-pdf text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    },
                    {
                        extend: 'csv',
                        text: '<i class="las la-file-csv text-xl"></i>',
                        className: 'btn btn-secondary border btn-xs',
                        title: title,
                        filename: title + '_' + new Date().toISOString().slice(0,10)
                    }
                ],
                lengthMenu: [
                    [15, 50, 100, -1],
                    ['15', '50', '100', 'Todos']
                ],
                pageLength: 15,
                searching: false,
                lengthChange: false,
                info: false,
                paging: false
            });
            
            // Mover los botones al contenedor específico
            var buttons = dataTable.buttons().container();
            buttons.appendTo('#' + containerId);
        }
    }
    
    // Inicializar todas las tablas
    {% if alerts.expired %}
        initializeDataTable('table-expired', 'buttons-expired', 'Elementos Vencidos');
    {% endif %}
    
    {% if alerts.due_10 %}
        initializeDataTable('table-due-10', 'buttons-due-10', 'Por Vencer 10 Días');
    {% endif %}
    
    {% if alerts.due_30 %}
        initializeDataTable('table-due-30', 'buttons-due-30', 'Por Vencer 30 Días');
    {% endif %}
    
    {% if equipment_status.with_issues %}
        initializeDataTable('table-equipment-issues', 'buttons-equipment-issues', 'Equipos con Inconsistencias');
    {% endif %}
    
    {% if equipment_status.incomplete %}
        initializeDataTable('table-equipment-incomplete', 'buttons-equipment-incomplete', 'Equipos Incompletos');
    {% endif %}
    
    {% if equipment_status.rented %}
        initializeDataTable('table-equipment-rented', 'buttons-equipment-rented', 'Equipos Rentados');
    {% endif %}
});
</script>
{% endblock %}