{% extends 'base/base.html' %}
{% load static %}
{% block content %}
<div id="projectApp" v-cloak data-project-id="{{ project.id }}" data-csrf="{{ csrf_token }}" data-start-date='{{ project.start_date|date:"Y-m-d" }}' data-end-date='{{ project.end_date|date:"Y-m-d" }}' class="w-[90%] mx-auto p-4 bg-white rounded-2xl shadow-md border border-blue-300 border-t-[15px] border-t-blue-300">
  <div class="flex justify-between items-center border-b-blue-500 border-b pb-1 mb-3">
    <h1 class="text-xl font-semibold text-blue-500">Ficha de Proyecto</h1>
    <div class="text-gray-500">
      <span class="badge {% if project.is_closed %}badge-warning{% else %}badge-success{% endif %}">
        {% if project.is_closed %}Cerrado{% else %}Abierto{% endif %}
      </span>
    </div>
  </div>

  {# Información del Proyecto #}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Columna 1 -->
    <div class="space-y-2">
      <div class="flex items-center gap-2 py-1 border-b border-gray-200">
        <i class="las la-hashtag text-blue-500"></i>
        <span class="text-xs text-gray-500 w-32">ID Proyecto:</span>
        <span class="font-semibold text-sm">#{{ project.id }}</span>
      </div>
      <div class="flex items-center gap-2 py-1 border-b border-gray-200">
        <i class="las la-building text-blue-500"></i>
        <span class="text-xs text-gray-500 w-32">Cliente:</span>
        <span class="font-semibold text-sm">
          <a href="{% if project.partner_id %}{% url 'partner_detail' project.partner_id %}{% else %}#{% endif %}" class="link link-hover">
            {{ project.partner }}
          </a>
        </span>
      </div>
      <div class="flex items-center gap-2 py-1 border-b border-gray-200">
        <i class="las la-map-marker text-blue-500"></i>
        <span class="text-xs text-gray-500 w-32">Ubicación:</span>
        <span class="font-semibold text-sm">{{ project.location|default:"N/A" }}</span>
      </div>
      <div class="flex items-center gap-2 py-1 border-b border-gray-200">
        <i class="las la-info-circle text-blue-500"></i>
        <span class="text-xs text-gray-500 w-32">Estado:</span>
        <span class="badge badge-sm {% if project.is_closed %}badge-warning{% else %}badge-success{% endif %}">
          {% if project.is_closed %}Cerrado{% else %}Abierto{% endif %}
        </span>
              type="text" 
              class="input input-bordered input-sm w-full" 
              id="sheet_contact_reference"
              placeholder="Nombre del contacto"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Teléfono Contacto:</span>
            </label>
            <input 
              type="text" 
              class="input input-bordered input-sm w-full" 
              id="sheet_contact_phone_reference"
              placeholder="Teléfono del contacto"
            />
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button 
          type="button" 
          class="btn btn-primary btn-sm" 
          id="btn_save_sheet"
        >
          <i class="las la-save"></i>
          Crear Planilla
        </button>
        <button 
          type="button" 
          class="btn btn-error btn-sm" 
          onclick="resetSheetForm()"
        >
          <i class="las la-times"></i>
          Cancelar
        </button>
      {% block script %}
      <script src="{% static 'js/app/app-projects.js' %}"></script>
      {% endblock %}
          resetSheetForm();
          location.reload();
        }, 1500);
      } else {
        showError(data.error || 'Error al crear planilla');
        btnSave.disabled = false;
        btnSave.innerHTML = '<i class="las la-save"></i> Crear Planilla';
      }
    })
    .catch(error => {
      showError('Error de conexión: ' + error.message);
      btnSave.disabled = false;
      btnSave.innerHTML = '<i class="las la-save"></i> Crear Planilla';
    });
  }
  
  // ============================================================
  // INICIALIZACIÓN
  // ============================================================
  
  // Cargar equipos cuando se abre el modal
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Presentación del proyecto cargada - ID:', project_id);
    
    // Observer para detectar cuando se abre el modal de equipos
    const modalEquipment = document.getElementById('modal_assign_equipment');
    const observerEquipment = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'open' && modalEquipment.hasAttribute('open')) {
          loadAvailableEquipment();
        }
      });
    });
    
    observerEquipment.observe(modalEquipment, { attributes: true });
    
    // Observer para detectar cuando se abre el modal de planilla
    const modalSheet = document.getElementById('modal_create_sheet');
    const observerSheet = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'open' && modalSheet.hasAttribute('open')) {
          loadNextSeriesCode();
        }
      });
    });
    
    observerSheet.observe(modalSheet, { attributes: true });
    
    // Listener para guardar planilla
    const btnSaveSheet = document.getElementById('btn_save_sheet');
    if (btnSaveSheet) {
      btnSaveSheet.addEventListener('click', saveSheet);
    }
    
    // Establecer fecha de hoy como default para fecha de emisión
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('sheet_issue_date').value = today;
  });
</script>
{% endblock %}