{% extends 'base/base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded-2xl shadow-md border border-t-[15px] border-t-blue-500">
  <div class="flex justify-between items-center border-b-blue-500 border-b pb-1 mb-3">
    <h1 class="text-2xl font-semibold text-blue-500">Ficha de Recurso</h1>
    <div class="flex flex-wrap gap-2 text-gray-500">
      <!-- Badge Estado Activo/Inactivo -->
      <span class="badge {% if equipment.is_active %}badge-success{% else %}badge-error{% endif %}">
        {% if equipment.is_active %}ACTIVO{% else %}INACTIVO{% endif %}
      </span>
      
      <!-- Badge Disponibilidad -->
      {% with availability=equipment.stst_status_disponibility %}
        <span class="badge text-white text-sm
          {% if availability == 'DISPONIBLE' %}badge-success{% elif availability == 'RENTADO' %}badge-info{% else %}badge-neutral{% endif %}">
          {{ availability|default:'Sin estado' }}
        </span>
      {% endwith %}
      
      <!-- Badge Estado Técnico -->
      {% with est=equipment.stst_status_equipment %}
        <span class="badge text-white text-sm
          {% if est == 'FUNCIONANDO' %}badge-success{% elif est == 'EN REPARACION' %}badge-warning{% elif est == 'DAÑADO' or est == 'DANADO' %}badge-error{% elif est == 'INCOMPLETO' %}badge-warning{% else %}badge-neutral{% endif %}">
          {{ est|default:'Sin estado' }}
        </span>
      {% endwith %}
    </div>
  </div>

  <!-- Tabs estilo técnico -->
  <div class="tabs tabs-box w-full mb-4">
    <!-- TAB 1: Información General -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Información General" checked />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-10">
        <!-- Col 1: Comunes -->
        <div class="space-y-1 border-l-blue-300 border-l-[1px] pl-5">
          {% for item in equipment.present_common_fields %}
            <div>
              <p class="text-gray-500 text-sm">{{ item.label }}</p>
              <p class="font-semibold text-gray-900">{{ item.value|default:'No registrado' }}</p>
            </div>
          {% empty %}
            <div class="text-gray-400">Sin campos comunes</div>
          {% endfor %}
        </div>

        <!-- Col 2: Específicos -->
        <div class="space-y-1 border-l-blue-300 border-l-[1px] pl-5">
          {% for item in equipment.present_specific_fields %}
            <div>
              <p class="text-gray-500 text-sm">{{ item.label }}</p>
              <p class="font-semibold text-gray-900">{{ item.value|default:'—' }}</p>
            </div>
          {% empty %}
            <div class="text-gray-400">Sin campos específicos</div>
          {% endfor %}
        </div>

        <!-- Col 3: Checklist have_* -->
        <div class="space-y-1 border-l-blue-300 border-l-[1px] pl-5">
          <p class="text-gray-500 text-sm">Checklist</p>
          <div class="space-y-1">
            {% for item in equipment.present_have_fields %}
              <label class="flex items-center gap-2">
                <input type="checkbox" class="checkbox checkbox-sm" {% if item.value %}checked{% endif %} disabled>
                <span class="font-semibold text-gray-900">{{ item.label }}</span>
              </label>
            {% empty %}
              <div class="text-gray-400">Sin checklist para este tipo</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 2: Estado y Proyectos -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Estado y Proyectos" />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <!-- Estado (3 columnas) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
          <div>
            <p class="text-gray-500 text-sm">Disponibilidad</p>
            {% with availability=equipment.stst_status_disponibility %}
              <span class="inline-block px-3 py-1 rounded-full text-white text-sm font-semibold
                {% if availability == 'DISPONIBLE' %}bg-green-600{% elif availability == 'RENTADO' %}bg-blue-600{% else %}bg-gray-600{% endif %}">{{ availability|default:'—' }}</span>
            {% endwith %}
          </div>
          <div>
            <p class="text-gray-500 text-sm">Estado Técnico</p>
            {% with est=equipment.stst_status_equipment %}
              <span class="inline-block px-3 py-1 rounded-full text-white text-sm font-semibold
                {% if est == 'FUNCIONANDO' %}bg-green-600{% elif est == 'EN REPARACION' %}bg-red-600{% elif est == 'DAÑADO' or est == 'DANADO' %}bg-red-600{% elif est == 'INCOMPLETO' %}bg-yellow-600{% else %}bg-gray-600{% endif %}">{{ est|default:'—' }}</span>
            {% endwith %}
          </div>
        </div>
        <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
          <div>
            <p class="text-gray-500 text-sm">Ubicación Actual</p>
            <p class="font-semibold text-gray-900">{{ equipment.stst_current_location|default:'—' }}</p>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Proyecto Actual</p>
            <p class="font-semibold text-gray-900">{% if current_assignment %}{{ current_assignment.project.partner.name }}{% else %}—{% endif %}</p>
          </div>
        </div>
        <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
          <div>
            <p class="text-gray-500 text-sm">Fecha de Ocupación</p>
            <p class="font-semibold text-gray-900">{{ equipment.stst_commitment_date|date:'d-m-Y'|default:'—' }}</p>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Fecha de Liberación</p>
            <p class="font-semibold text-gray-900">{{ equipment.stst_release_date|date:'d-m-Y'|default:'—' }}</p>
          </div>
          {% if equipment.stst_repair_reason %}
          <div>
            <p class="text-gray-500 text-sm">Motivo Reparación</p>
            <p class="font-semibold text-gray-900">{{ equipment.stst_repair_reason }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Proyectos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <div>
          <h3 class="text-md font-semibold text-blue-500 mb-2">Proyecto Actual</h3>
          {% if current_assignment %}
          <div class="p-4 bg-green-50 rounded-lg border border-green-200">
            <div class="space-y-2">
              <div><span class="text-gray-500 text-sm">Cliente:</span> <span class="font-medium">{{ current_assignment.project.partner.name }}</span></div>
              <div><span class="text-gray-500 text-sm">Lugar:</span> <span class="font-medium">{{ current_assignment.project.place|default:'No especificado' }}</span></div>
              <div><span class="text-gray-500 text-sm">Periodo:</span> <span class="font-medium">{{ current_assignment.start_date|date:'d/m/Y' }} - {{ current_assignment.end_date|date:'d/m/Y' }}</span></div>
              <div><span class="text-gray-500 text-sm">Costo:</span> <span class="font-medium">${{ current_assignment.cost|floatformat:2 }}</span></div>
            </div>
          </div>
          {% else %}
          <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
            <p class="text-gray-500">No hay proyecto asignado actualmente</p>
          </div>
          {% endif %}
        </div>
        <div>
          <h3 class="text-md font-semibold text-blue-500 mb-2">Historial de Proyectos</h3>
          {% if recent_assignments %}
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {% for assignment in recent_assignments %}
            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium text-sm">{{ assignment.project.partner.name }}</p>
                  <p class="text-xs text-gray-500">{{ assignment.start_date|date:'d/m/Y' }} - {{ assignment.end_date|date:'d/m/Y' }}</p>
                </div>
                <span class="badge badge-sm {% if assignment.is_active %}badge-success{% else %}badge-outline{% endif %}">{% if assignment.is_active %}Activo{% else %}Finalizado{% endif %}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"><p class="text-gray-500">Sin historial de proyectos</p></div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- TAB 3: Metadatos -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Metadatos" />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <h3 class="text-md font-semibold text-blue-500 mb-4">Información de Auditoría</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Registro Inicial -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-medium text-gray-700 mb-3">Registro Inicial</h4>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Fecha de Registro:</span> <span class="font-medium">{{ equipment.created_at|date:'d-m-Y H:i'|default:'No registrada' }}</span></div>
            <div><span class="text-gray-500">Usuario Registrador:</span> <span class="font-medium"></span></div>
            <div><span class="text-gray-500">ID del Registro:</span> <span class="font-medium font-mono">#{{ equipment.id }}</span></div>
          </div>
        </div>
        <!-- Última Modificación -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-medium text-gray-700 mb-3">Última Modificación</h4>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Fecha de Modificación:</span> <span class="font-medium">{{ equipment.updated_at|date:'d-m-Y H:i'|default:'No modificado' }}</span></div>
            <div><span class="text-gray-500">Usuario Modificador:</span> <span class="font-medium"></span></div>
            <div><span class="text-gray-500">Estado del Registro:</span> <span class="badge badge-sm {% if equipment.is_active %}badge-success{% else %}badge-error{% endif %}">{% if equipment.is_active %}Activo{% else %}Inactivo{% endif %}</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="flex flex-wrap justify-center gap-2 mt-3 border-t pt-3">
    <a href="{% url 'resource_create' %}" class="btn btn-soft btn-default">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" />
      </svg>
      Nuevo
    </a>
    <a href="{% url 'resource_update' equipment.id %}" class="btn btn-soft">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" /><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" /><path d="M16 5l3 3" />
      </svg>
      Editar
    </a>
    <a href="{% url 'resource_detail' equipment.id %}?action=delete" class="btn btn-soft btn-error">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
      </svg>
      Eliminar
    </a>
    <a href="{% url 'resource_list' %}" class="btn btn-sm btn-outline border-black">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M9 6l-6 6l6 6"></path>
        <path d="M21 6l-6 6l6 6"></path>
      </svg>
      Volver al Listado
    </a>
  </div>

  <!-- Confirmación de eliminación -->
  {% if action == 'delete' %}
  <div class="mt-4 p-3 bg-red-50 rounded-md border border-red-200">
    <p class="text-red-700 mb-2">¿Estás seguro de que deseas eliminar este equipo? Esta acción no se puede deshacer.</p>
    <div class="flex justify-center gap-2">
      <a href="{% url 'resource_delete' equipment.id %}" class="btn btn-soft btn-error">Confirmar Eliminación</a>
      <a href="{% url 'resource_detail' equipment.id %}" class="btn btn-outline ml-2 border-black">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M9 6l-6 6l6 6"></path>
          <path d="M21 6l-6 6l6 6"></path>
        </svg>
        Cancelar
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
