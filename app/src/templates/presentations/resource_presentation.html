{% extends 'base/base.html' %}
{% load static %}
{% block content %}
<div class="max-w-7xl mx-auto p-6 bg-white rounded-2xl shadow-md border border-t-[15px] border-t-blue-500" data-equipment-id="{{ equipment.id }}" data-api-update="{% url 'api_update_resource' %}">
  <div class="flex justify-between items-center border-b-blue-500 border-b pb-1 mb-3">
    <h1 class="text-2xl font-semibold text-blue-500">
      {% if equipment.code %}[{{ equipment.code }}] {% endif %}{{ equipment.name|default:'Sin nombre'|upper }}
    </h1>
    <div class="flex flex-wrap gap-2 text-gray-500">
      <!-- Badge Estado Activo/Inactivo -->
      <span data-active-badge class="badge {% if equipment.is_active %}badge-success{% else %}badge-error{% endif %}">
        {% if equipment.is_active %}ACTIVO{% else %}INACTIVO{% endif %}
      </span>
      <!-- Toggle Activo/Inactivo -->
      <label class="flex items-center gap-2 ml-1">
        <input type="checkbox" class="checkbox checkbox-sm js-field-toggle" data-field="is_active" {% if equipment.is_active %}checked{% endif %}>
        <span class="text-xs text-gray-600">Activo</span>
      </label>
      
      <!-- Badge Disponibilidad -->
      {% with availability=equipment.stst_status_disponibility %}
        <span class="badge text-white text-sm
          {% if availability == 'DISPONIBLE' %}badge-success{% elif availability == 'RENTADO' %}badge-info{% else %}badge-neutral{% endif %}">
          {{ availability|default:'Sin estado' }}
        </span>
      {% endwith %}
      
      <!-- Badge Estado Técnico -->
      {% with est=equipment.stst_status_equipment %}
        <span data-tech-status data-variant="badge" class="badge text-white text-sm
          {% if est == 'FUNCIONANDO' %}badge-success{% elif est == 'EN REPARACION' %}badge-warning{% elif est == 'DAÑADO' or est == 'DANADO' %}badge-error{% elif est == 'INCOMPLETO' %}badge-warning{% else %}badge-neutral{% endif %}">
          {{ est|default:'Sin estado' }}
        </span>
      {% endwith %}
      
      <!-- Badge Análisis de Estado -->
      {% if status_analysis %}
        <span class="badge {{ status_class_mapping.overall_badge }} text-sm">
          {% if equipment_completeness.is_complete and not inconsistencies_analysis.needs_update %}
            ✓ ESTADO OK
          {% elif inconsistencies_analysis.needs_update %}
            ⚠ REQUIERE ATENCIÓN
          {% else %}
            ⚡ INCOMPLETO
          {% endif %}
        </span>
      {% endif %}
    </div>
  </div>

  <!-- Tabs estilo técnico -->
  <div class="tabs tabs-box w-full mb-4">
    <!-- TAB 1: Información General -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Información General" checked />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <!-- Información básica en 3 columnas para mejor aprovechamiento del espacio -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Columna 1: Información Común -->
        <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
          <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
            <i class="las la-info-circle text-lg text-blue-600"></i>
            Información Común
          </h4>
          <div class="space-y-3">
            {% for item in equipment.present_common_fields %}
              <div class="bg-white p-3 rounded-lg border border-blue-100">
                <div class="flex items-center gap-2">
                  <i class="las la-tag text-blue-500"></i>
                  <p class="text-gray-500 text-sm">{{ item.label }}</p>
                </div>
                <p class="font-semibold text-gray-900 pl-6">{{ item.value|default:"<span class='text-gray-400 text-sm italic'>No registrado</span>"|safe }}</p>
              </div>
            {% empty %}
              <div class="bg-white p-3 rounded-lg border border-gray-100 text-center">
                <p class="text-gray-400 text-sm italic">Sin campos comunes</p>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Columna 2: Información Específica -->
        <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
          <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
            <i class="las la-cogs text-lg text-blue-600"></i>
            Información Específica
          </h4>
          <div class="space-y-3">
            {% for item in equipment.present_specific_fields %}
              <div class="bg-white p-3 rounded-lg border border-blue-100">
                <div class="flex items-center gap-2">
                  <i class="las la-wrench text-blue-500"></i>
                  <p class="text-gray-500 text-sm">{{ item.label }}</p>
                </div>
                <p class="font-semibold text-gray-900 pl-6">{{ item.value|default:"<span class='text-gray-400 text-sm italic'>No registrado</span>"|safe }}</p>
              </div>
            {% empty %}
              <div class="bg-white p-3 rounded-lg border border-gray-100 text-center">
                <p class="text-gray-400 text-sm italic">Sin campos específicos</p>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Columna 3: Checklist -->
        <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
          <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
            <i class="las la-check-square text-lg text-blue-600"></i>
            Checklist de Componentes
          </h4>
          <div class="space-y-2">
            {% for item in equipment.present_have_fields %}
              <div class="bg-white p-3 rounded-lg border border-blue-100">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" class="checkbox checkbox-sm js-have-toggle" data-field="{{ item.name }}" {% if item.value %}checked{% endif %}>
                  <div class="flex items-center gap-2 flex-1">
                    <i class="las la-tools text-blue-500"></i>
                    <span class="text-gray-900 text-sm">{{ item.label }}</span>
                  </div>
                </label>
              </div>
            {% empty %}
              <div class="bg-white p-3 rounded-lg border border-gray-100 text-center">
                <p class="text-gray-400 text-sm italic">Sin checklist para este tipo</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 2: Estado y Análisis -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Estado y Análisis" />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      {% if status_analysis %}
        <!-- Resumen del Estado General -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Estado de Completitud -->
          <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
            <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
              <i class="las la-check-circle text-lg"></i>
              Estado de Completitud
            </h4>
            <div class="text-center">
              <div class="text-3xl font-bold {{ status_class_mapping.completeness_class }}">
                {{ equipment_completeness.completion_percentage|floatformat:1 }}%
              </div>
              <span class="badge {{ status_class_mapping.completion_badge }}">
                {% if equipment_completeness.is_complete %}COMPLETO{% else %}INCOMPLETO{% endif %}
              </span>
              {% if equipment_completeness.missing_count > 0 %}
                <p class="text-sm text-gray-600 mt-2">
                  Faltan {{ equipment_completeness.missing_count }} elemento{{ equipment_completeness.missing_count|pluralize }}
                </p>
              {% endif %}
            </div>
          </div>

          <!-- Estado de Disponibilidad -->
          <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
            <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
              <i class="las la-calendar-check text-lg"></i>
              Disponibilidad
            </h4>
            <div class="text-center">
              <span class="badge {{ status_class_mapping.availability_class }} text-lg px-4 py-2">
                {{ equipment_availability.status }}
              </span>
              {% if equipment_availability.current_location %}
                <p class="text-sm text-gray-600 mt-2">
                  <i class="las la-map-marker"></i> {{ equipment_availability.current_location }}
                </p>
              {% endif %}
            </div>
          </div>

          <!-- Estado de Consistencia -->
          <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-blue-200">
            <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
              <i class="las la-exclamation-triangle text-lg"></i>
              Consistencia de Datos
            </h4>
            <div class="text-center">
              <span class="badge {{ status_class_mapping.inconsistencies_badge }} text-lg px-4 py-2">
                {% if inconsistencies_analysis.needs_update %}REQUIERE ATENCIÓN{% else %}CORRECTO{% endif %}
              </span>
              {% if inconsistencies_analysis.count > 0 %}
                <p class="text-sm text-red-600 mt-2">
                  {{ inconsistencies_analysis.count }} problema{{ inconsistencies_analysis.count|pluralize }} encontrado{{ inconsistencies_analysis.count|pluralize }}
                </p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Estados Detallados del Equipo -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
            <div>
              <p class="text-gray-500 text-sm">Disponibilidad</p>
              {% with availability=equipment.stst_status_disponibility %}
                <span class="inline-block px-3 py-1 rounded-full text-white text-sm font-semibold
                  {% if availability == 'DISPONIBLE' %}bg-green-600{% elif availability == 'RENTADO' %}bg-blue-600{% else %}bg-gray-600{% endif %}">{{ availability|default:'—' }}</span>
              {% endwith %}
            </div>
            <div>
              <p class="text-gray-500 text-sm">Estado Técnico</p>
              {% with est=equipment.stst_status_equipment %}
                <span data-tech-status data-variant="pill" class="inline-block px-3 py-1 rounded-full text-white text-sm font-semibold
                  {% if est == 'FUNCIONANDO' %}bg-green-600{% elif est == 'EN REPARACION' %}bg-red-600{% elif est == 'DAÑADO' or est == 'DANADO' %}bg-red-600{% elif est == 'INCOMPLETO' %}bg-yellow-600{% else %}bg-gray-600{% endif %}">{{ est|default:'—' }}</span>
              {% endwith %}
            </div>
          </div>
          <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
            <div>
              <p class="text-gray-500 text-sm">Ubicación Actual</p>
              <p class="font-semibold text-gray-900">{{ equipment.stst_current_location|default:'—' }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Proyecto Actual</p>
              <p class="font-semibold text-gray-900">{% if current_assignment %}{{ current_assignment.project.partner.name }}{% else %}—{% endif %}</p>
            </div>
          </div>
          <div class="space-y-3 border-l-blue-300 border-l-[1px] pl-5">
            <div>
              <p class="text-gray-500 text-sm">Fecha de Ocupación</p>
              <p class="font-semibold text-gray-900">{{ equipment.stst_commitment_date|date:'d-m-Y'|default:'—' }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Fecha de Liberación</p>
              <p class="font-semibold text-gray-900">{{ equipment.stst_release_date|date:'d-m-Y'|default:'—' }}</p>
            </div>
            {% if equipment.stst_repair_reason %}
            <div>
              <p class="text-gray-500 text-sm">Motivo Reparación</p>
              <p class="font-semibold text-gray-900">{{ equipment.stst_repair_reason }}</p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Información de Proyectos y Análisis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Proyecto Actual -->
          <div>
            <h3 class="text-md font-semibold text-blue-500 mb-2">Proyecto Actual</h3>
            {% if current_assignment %}
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
              <div class="space-y-2">
                <div><span class="text-gray-500 text-sm">Cliente:</span> <span class="font-medium">{{ current_assignment.project.partner.name }}</span></div>
                <div><span class="text-gray-500 text-sm">Campamento:</span> <span class="font-medium">{{ current_assignment.project.location|default:'No especificado' }}</span></div>
                <div><span class="text-gray-500 text-sm">Periodo:</span> <span class="font-medium">{{ current_assignment.operation_start_date|date:'d/m/Y' }} - {{ current_assignment.operation_end_date|date:'d/m/Y' }}</span></div>
                <div><span class="text-gray-500 text-sm">Costo:</span> <span class="font-medium">${{ current_assignment.rent_cost|floatformat:2 }}</span></div>
              </div>
            </div>
            {% else %}
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
              <p class="text-gray-500">No hay proyecto asignado actualmente</p>
            </div>
            {% endif %}
          </div>

          <!-- Información de Renta -->
          {% if rental_analysis %}
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
              <h4 class="font-medium text-green-700 mb-3 flex items-center gap-2">
                <i class="las la-handshake text-lg"></i>
                Información de Renta
              </h4>
              <div class="space-y-2">
                <div>
                  <span class="text-gray-600 text-sm">Cliente:</span>
                  <div class="font-medium">{{ rental_analysis.project_partner }}</div>
                </div>
                <div>
                  <span class="text-gray-600 text-sm">Estado:</span>
                  <div>
                    <span class="badge 
                      {% if rental_analysis.rental_status == 'ACTIVO' %}badge-success
                      {% elif rental_analysis.rental_status == 'VENCIDO' %}badge-error
                      {% else %}badge-warning{% endif %}">
                      {{ rental_analysis.rental_status }}
                    </span>
                  </div>
                </div>
                <div>
                  <span class="text-gray-600 text-sm">Días restantes:</span>
                  <div class="font-medium">{{ rental_analysis.remaining_days|default:'N/A' }}</div>
                </div>
              </div>
            </div>
          {% else %}
            <!-- Historial de Proyectos si no hay renta activa -->
            <div>
              <h3 class="text-md font-semibold text-blue-500 mb-2">Historial de Proyectos</h3>
              {% if recent_assignments %}
              <div class="space-y-2 max-h-64 overflow-y-auto">
                {% for assignment in recent_assignments %}
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-medium text-sm">{{ assignment.project.partner.name }}</p>
                      <p class="text-xs text-gray-500">{{ assignment.operation_start_date|date:'d/m/Y' }} - {{ assignment.operation_end_date|date:'d/m/Y' }}</p>
                    </div>
                    <span class="badge badge-sm {% if not assignment.is_retired %}badge-success{% else %}badge-outline{% endif %}">{% if not assignment.is_retired %}Vigente{% else %}Retirado{% endif %}</span>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"><p class="text-gray-500">Sin historial de proyectos</p></div>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <!-- Detalles del Análisis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Elementos Faltantes -->
          {% if equipment_completeness.missing_items %}
            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <h4 class="font-medium text-red-700 mb-3 flex items-center gap-2">
                <i class="las la-times-circle text-lg"></i>
                Elementos Faltantes ({{ equipment_completeness.missing_count }})
              </h4>
              <div class="space-y-2">
                {% for item in equipment_completeness.missing_items %}
                  <div class="bg-white p-2 rounded border border-red-100">
                    <span class="text-red-700 font-medium">{{ item.label }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Recomendaciones -->
          {% if recommendations %}
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <h4 class="font-medium text-blue-700 mb-3 flex items-center gap-2">
                <i class="las la-lightbulb text-lg"></i>
                Recomendaciones
              </h4>
              <div class="space-y-2">
                {% for recommendation in recommendations %}
                  <div class="bg-white p-2 rounded border border-blue-100">
                    <span class="text-blue-700">• {{ recommendation }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Inconsistencias -->
          {% if inconsistencies_analysis.found %}
            <div class="p-4 bg-red-50 rounded-lg border border-red-200 md:col-span-2">
              <h4 class="font-medium text-red-700 mb-3 flex items-center gap-2">
                <i class="las la-exclamation-circle text-lg"></i>
                Inconsistencias Detectadas ({{ inconsistencies_analysis.count }})
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for inconsistency in inconsistencies_analysis.found %}
                  <div class="bg-white p-3 rounded border border-red-100">
                    <div class="font-medium text-red-800">{{ inconsistency.type }}</div>
                    <div class="text-sm text-gray-700 mt-1">{{ inconsistency.description }}</div>
                    <div class="text-xs text-blue-600 mt-2">
                      <strong>Acción:</strong> {{ inconsistency.action }}
                    </div>
                  </div>
                {% endfor %}
              </div>
              {% if inconsistencies_analysis.needs_update %}
                <div class="mt-4 text-center">
                  <button class="btn btn-warning" onclick="updateEquipmentStatus({{ equipment.id }})">
                    <i class="las la-tools"></i>
                    Corregir Automáticamente
                  </button>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-center p-8">
          <i class="las la-exclamation-triangle text-6xl text-gray-400"></i>
          <p class="text-gray-600 mt-4">No se pudo obtener el análisis de estado del equipo</p>
        </div>
      {% endif %}
    </div>

    <!-- TAB 3: Metadatos -->
    <input type="radio" name="res_tabs" class="tab" aria-label="Metadatos" />
    <div class="tab-content bg-base-100 border-base-300 p-6">
      <h3 class="text-md font-semibold text-blue-500 mb-4">Información de Auditoría</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Registro Inicial -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-medium text-gray-700 mb-3">Registro Inicial</h4>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Fecha de Registro:</span> <span class="font-medium">{{ equipment.created_at|date:'d-m-Y H:i'|default:'No registrada' }}</span></div>
            <div><span class="text-gray-500">Usuario Registrador:</span> <span class="font-medium"></span></div>
            <div><span class="text-gray-500">ID del Registro:</span> <span class="font-medium font-mono">#{{ equipment.id }}</span></div>
          </div>
        </div>
        <!-- Última Modificación -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <h4 class="font-medium text-gray-700 mb-3">Última Modificación</h4>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Fecha de Modificación:</span> <span class="font-medium">{{ equipment.updated_at|date:'d-m-Y H:i'|default:'No modificado' }}</span></div>
            <div><span class="text-gray-500">Usuario Modificador:</span> <span class="font-medium"></span></div>
            <div><span class="text-gray-500">Estado del Registro:</span> <span class="badge badge-sm {% if equipment.is_active %}badge-success{% else %}badge-error{% endif %}">{% if equipment.is_active %}Activo{% else %}Inactivo{% endif %}</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<div class="mt-6 pt-2 border border-gray-200 p-2 rounded">
    <h3 class="text-md font-semibold text-blue-500 mb-2">Notas</h3>
    <p class="text-gray-800 whitespace-pre-line">{{ equipment.notes|default:'Sin notas' }}</p>
  </div>
  <!-- Botones de acción -->
  <div class="flex flex-wrap justify-center gap-2 mt-3 border-t pt-3">
    <a href="{% url 'resource_create' %}" class="btn btn-soft btn-default">
      <i class="las la-plus text-xl"></i>
      Nuevo
    </a>
    <a href="{% url 'resource_update' equipment.id %}" class="btn btn-soft">
      <i class="las la-edit text-xl"></i>
      Editar
    </a>
    <a href="{% url 'resource_detail' equipment.id %}?action=delete" class="btn btn-soft btn-error">
      <i class="las la-trash text-xl"></i>
      Eliminar
    </a>
    <a href="{% url 'resource_list' %}" class="btn btn-sm btn-outline border-black">
      <i class="las la-arrow-left text-xl"></i>
      Volver al Listado
    </a>
  </div>
  <!-- Confirmación de eliminación -->
  {% if action == 'delete' %}
  <div class="mt-4 p-3 bg-red-50 rounded-md border border-red-200">
    <p class="text-red-700 mb-2">¿Estás seguro de que deseas eliminar este equipo? Esta acción no se puede deshacer.</p>
    <div class="flex justify-center gap-2">
      <a href="{% url 'resource_delete' equipment.id %}" class="btn btn-soft btn-error">Confirmar Eliminación</a>
      <a href="{% url 'resource_detail' equipment.id %}" class="btn btn-outline ml-2 border-black">
        <i class="las la-times text-xl"></i>
        Cancelar
      </a>
    </div>
  </div>
  {% endif %} 
</div>
{% block script %}
<script src="{% static 'js/app/app-resources-presentations.js' %}"></script>
<script>
function updateEquipmentStatus(equipmentId) {
    if (confirm('¿Desea corregir automáticamente las inconsistencias encontradas?')) {
        // Aquí puedes agregar la lógica AJAX para actualizar el estado
        // Por ahora, recargamos la página para mostrar el estado actualizado
        fetch('/api/equipment/' + equipmentId + '/fix-status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Estado del equipo actualizado correctamente');
                location.reload();
            } else {
                alert('Error al actualizar el estado: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar el estado del equipo');
        });
    }
}
</script>
{% endblock %}
{% endblock %}
